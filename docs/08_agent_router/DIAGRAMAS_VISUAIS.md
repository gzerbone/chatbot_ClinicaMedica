# ğŸ“Š Diagramas Visuais - Agent Router

> ColeÃ§Ã£o de diagramas visuais detalhados para facilitar a compreensÃ£o do Agent Router

---

## ğŸ“‘ Ãndice de Diagramas

1. [VisÃ£o Geral 360Â°](#visÃ£o-geral-360)
2. [Fluxo de Dados Detalhado](#fluxo-de-dados-detalhado)
3. [Ãrvore de DecisÃ£o de Roteamento](#Ã¡rvore-de-decisÃ£o-de-roteamento)
4. [Ciclo de Vida de uma Mensagem](#ciclo-de-vida-de-uma-mensagem)
5. [MÃ¡quina de Estados Completa](#mÃ¡quina-de-estados-completa)
6. [Arquitetura em Camadas](#arquitetura-em-camadas)
7. [Tratamento de Erros](#tratamento-de-erros)
8. [IntegraÃ§Ã£o de ServiÃ§os](#integraÃ§Ã£o-de-serviÃ§os)
9. [Fluxo de Agendamento Completo](#fluxo-de-agendamento-completo)
10. [Pipeline de Processamento](#pipeline-de-processamento)

---

## ğŸŒ VisÃ£o Geral 360Â°

```
                                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                                â•‘           CHATBOT CLÃNICA MÃ‰DICA - AGENT ROUTER        â•‘
                                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         ENTRADA                                                     â”‚
â”‚                                                                                                     â”‚
â”‚   ğŸ‘¤ UsuÃ¡rio â†’ ğŸ“± WhatsApp â†’ ğŸŒ Internet â†’ ğŸ”— Webhook â†’ ğŸ Django                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    ğŸ¯ AGENT ROUTER (GeminiChatbotService)  â”‚
                    â”‚                                            â”‚
                    â”‚  â€¢ AnÃ¡lise de IntenÃ§Ã£o                     â”‚
                    â”‚  â€¢ ExtraÃ§Ã£o de Entidades                   â”‚
                    â”‚  â€¢ DecisÃ£o de Roteamento                   â”‚
                    â”‚  â€¢ CoordenaÃ§Ã£o de ServiÃ§os                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚                                 â”‚
        â”‚        CAMADA DE ANÃLISE        â”‚                                 â”‚
        â”‚                                 â”‚                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Intent     â”‚            â”‚ ğŸ“¦ Entity               â”‚         â”‚ ğŸ’¬ Response      â”‚
â”‚   Detector    â”‚            â”‚    Extractor            â”‚         â”‚    Generator     â”‚
â”‚               â”‚            â”‚                         â”‚         â”‚                  â”‚
â”‚ - Gemini AI   â”‚            â”‚ - Gemini AI             â”‚         â”‚ - Gemini AI      â”‚
â”‚ - Keywords    â”‚            â”‚ - Regex                 â”‚         â”‚ - Prompts        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚                                 â”‚
        â”‚       RESULTADO: intent         â”‚   RESULTADO: entities           â”‚
        â”‚                                 â”‚                                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     ğŸ§­ DECISÃƒO DE ROTEAMENTO               â”‚
                    â”‚                                            â”‚
                    â”‚  Intent detectado â†’ Seleciona ServiÃ§o     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚                                  â”‚
        â”‚        CAMADA DE SERVIÃ‡OS       â”‚                                  â”‚
        â”‚                                 â”‚                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“š RAG         â”‚        â”‚ ğŸ“… Smart                 â”‚       â”‚ ğŸ”— Handoff          â”‚
â”‚    Service     â”‚        â”‚    Scheduling            â”‚       â”‚    Service          â”‚
â”‚                â”‚        â”‚                          â”‚       â”‚                     â”‚
â”‚ Base de        â”‚        â”‚ - Google Calendar        â”‚       â”‚ - Links             â”‚
â”‚ Conhecimento   â”‚        â”‚ - Disponibilidade        â”‚       â”‚ - ConfirmaÃ§Ã£o       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚                              â”‚
        â”‚      RESULTADO: informaÃ§Ã£o      â”‚   RESULTADO: horÃ¡rios        â”‚ RESULTADO: link
        â”‚                                 â”‚                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     ğŸ’¾ PERSISTÃŠNCIA                        â”‚
                    â”‚                                            â”‚
                    â”‚  â€¢ SessionManager (cache + BD)             â”‚
                    â”‚  â€¢ ConversationService (histÃ³rico)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         SAÃDA                                                       â”‚
â”‚                                                                                                     â”‚
â”‚   ğŸ Django â†’ ğŸ”— Webhook â†’ ğŸŒ Internet â†’ ğŸ“± WhatsApp â†’ ğŸ‘¤ UsuÃ¡rio                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo de Dados Detalhado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            FLUXO DE DADOS NO AGENT ROUTER                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Mensagem    â”‚  "Quero agendar uma consulta com cardiologista"
    â”‚  do UsuÃ¡rio  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                        ETAPA 1: CONTEXTO                                â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  SessionManager.get_or_create_session(phone_number)             â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚  Retorna:                                                        â”‚  â”‚
           â”‚   â”‚  {                                                               â”‚  â”‚
           â”‚   â”‚    phone_number: "+5511999999999",                              â”‚  â”‚
           â”‚   â”‚    current_state: "idle",                                       â”‚  â”‚
           â”‚   â”‚    patient_name: null,                                          â”‚  â”‚
           â”‚   â”‚    selected_specialty: null,                                    â”‚  â”‚
           â”‚   â”‚    ...                                                           â”‚  â”‚
           â”‚   â”‚  }                                                               â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  SessionManager.get_conversation_history(phone_number)          â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚  Retorna: [Ãºltimas 4 mensagens da conversa]                     â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  RAGService.get_clinic_data()                                   â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚  Retorna: {mÃ©dicos, especialidades, convÃªnios, ...}             â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                        ETAPA 2: ANÃLISE                                 â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  IntentDetector.analyze_message(msg, session, history, clinic)  â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚  Entrada: Mensagem + Contexto                                   â”‚  â”‚
           â”‚   â”‚  Processo: Gemini AI analisa com prompt estruturado             â”‚  â”‚
           â”‚   â”‚  SaÃ­da:                                                          â”‚  â”‚
           â”‚   â”‚  {                                                               â”‚  â”‚
           â”‚   â”‚    intent: "agendar_consulta",                                  â”‚  â”‚
           â”‚   â”‚    next_state: "selecting_specialty",                           â”‚  â”‚
           â”‚   â”‚    confidence: 0.95,                                            â”‚  â”‚
           â”‚   â”‚    reasoning: "UsuÃ¡rio quer agendar com especialidade"          â”‚  â”‚
           â”‚   â”‚  }                                                               â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  EntityExtractor.extract_entities(msg, session, history, clinic)â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚  Entrada: Mensagem + Contexto                                   â”‚  â”‚
           â”‚   â”‚  Processo: Gemini AI extrai entidades                           â”‚  â”‚
           â”‚   â”‚  SaÃ­da:                                                          â”‚  â”‚
           â”‚   â”‚  {                                                               â”‚  â”‚
           â”‚   â”‚    specialty: "Cardiologia",                                    â”‚  â”‚
           â”‚   â”‚    patient_name: null,                                          â”‚  â”‚
           â”‚   â”‚    doctor: null,                                                â”‚  â”‚
           â”‚   â”‚    date: null,                                                  â”‚  â”‚
           â”‚   â”‚    time: null                                                   â”‚  â”‚
           â”‚   â”‚  }                                                               â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                     ETAPA 3: ROTEAMENTO                                 â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  if intent == 'agendar_consulta':                               â”‚  â”‚
           â”‚   â”‚      SmartSchedulingService.analyze_scheduling_request()         â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚      â”œâ”€> Valida especialidade no banco                          â”‚  â”‚
           â”‚   â”‚      â”œâ”€> Busca mÃ©dicos disponÃ­veis                              â”‚  â”‚
           â”‚   â”‚      â””â”€> GoogleCalendarService.get_availability()               â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚  Retorna:                                                        â”‚  â”‚
           â”‚   â”‚  {                                                               â”‚  â”‚
           â”‚   â”‚    response_type: "availability_info",                          â”‚  â”‚
           â”‚   â”‚    doctor_info: {nome: "Dr. JoÃ£o", crm: "12345"},               â”‚  â”‚
           â”‚   â”‚    calendar_availability: {                                     â”‚  â”‚
           â”‚   â”‚      has_availability: true,                                    â”‚  â”‚
           â”‚   â”‚      available_slots: 5,                                        â”‚  â”‚
           â”‚   â”‚      next_available: "2025-11-12 14:00"                         â”‚  â”‚
           â”‚   â”‚    }                                                             â”‚  â”‚
           â”‚   â”‚  }                                                               â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                    ETAPA 4: RESPOSTA                                    â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  ResponseGenerator.generate_response()                           â”‚  â”‚
           â”‚   â”‚                                                                  â”‚  â”‚
           â”‚   â”‚  Entrada: AnÃ¡lise + Resultado do roteamento                     â”‚  â”‚
           â”‚   â”‚  Processo: Gemini AI gera resposta natural                      â”‚  â”‚
           â”‚   â”‚  SaÃ­da:                                                          â”‚  â”‚
           â”‚   â”‚  {                                                               â”‚  â”‚
           â”‚   â”‚    response: "Ã“timo! Temos cardiologistas disponÃ­veis.          â”‚  â”‚
           â”‚   â”‚               Qual Ã© o seu nome completo?"                       â”‚  â”‚
           â”‚   â”‚  }                                                               â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                   ETAPA 5: PERSISTÃŠNCIA                                 â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  SessionManager.update_session()                                 â”‚  â”‚
           â”‚   â”‚  â”œâ”€> Atualiza current_state: "collecting_patient_info"          â”‚  â”‚
           â”‚   â”‚  â”œâ”€> Salva selected_specialty: "Cardiologia"                    â”‚  â”‚
           â”‚   â”‚  â””â”€> Sincroniza cache + banco de dados                          â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚   â”‚  SessionManager.save_messages()                                  â”‚  â”‚
           â”‚   â”‚  â”œâ”€> Salva mensagem do usuÃ¡rio                                  â”‚  â”‚
           â”‚   â”‚  â””â”€> Salva resposta do bot                                      â”‚  â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Resposta    â”‚  "Ã“timo! Temos cardiologistas disponÃ­veis.
    â”‚  Enviada     â”‚   Qual Ã© o seu nome completo?"
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ³ Ãrvore de DecisÃ£o de Roteamento

```
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚  MENSAGEM       â”‚
                                   â”‚  RECEBIDA       â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚  IntentDetector â”‚
                                   â”‚  Analisa Intent â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                   â”‚                   â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                 â”‚  saudacao   â”‚    â”‚ buscar_info â”‚    â”‚  agendar_   â”‚
                 â”‚             â”‚    â”‚             â”‚    â”‚  consulta   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                   â”‚                   â”‚
                        â”‚                   â”‚                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Estado == 'idle'?     â”‚       â”‚       â”‚ Verificar estado      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    SIM â”‚ NÃƒO               â”‚               SIM â”‚ NÃƒO
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚        â”‚       â”‚       â”‚              â”‚        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”  â”‚       â”‚   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ Perguntar â”‚  â”‚ Continuar â”‚  â”‚       â”‚   â”‚ Iniciar  â”‚  â”‚Continuar â”‚ â”‚
    â”‚   nome    â”‚  â”‚   fluxo   â”‚  â”‚       â”‚   â”‚agendamentâ”‚  â”‚  coleta  â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                   â”‚       â”‚                              â”‚
                                   â”‚       â”‚                              â”‚
                                   â”‚   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                                   â”‚   â”‚ Estado == 'idle'?   â”‚           â”‚
                                   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                   â”‚       SIM â”‚ NÃƒO                     â”‚
                                   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”               â”‚
                                   â”‚   â”‚          â”‚      â”‚               â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                           â”‚ ResponseGen  â”‚  â”‚ Em meio a agendamentoâ”‚   â”‚
                           â”‚ (saudaÃ§Ã£o)   â”‚  â”‚ PAUSAR para dÃºvida   â”‚   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                                  â”‚                     â”‚
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                                   â”‚ ConversationService        â”‚       â”‚
                                   â”‚ .pause_for_question()      â”‚       â”‚
                                   â”‚ - Salva previous_state     â”‚       â”‚
                                   â”‚ - Muda para answering_q    â”‚       â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                                                  â”‚                     â”‚
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                                   â”‚ RAGService                 â”‚       â”‚
                                   â”‚ Busca na base conhecimento â”‚       â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                                                  â”‚                     â”‚
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                                   â”‚ ResponseGenerator          â”‚       â”‚
                                   â”‚ Responde + sugere retomar  â”‚       â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                                                                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SmartScheduling      â”‚
    â”‚ Service              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Specialty extraÃ­da?  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            SIM â”‚ NÃƒO
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Buscar mÃ©ds  â”‚ â”‚ Perguntar      â”‚
â”‚ da especial. â”‚ â”‚ especialidade  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GoogleCalendar       â”‚
â”‚ .get_availability()  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tem horÃ¡rios?    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
SIM â”‚ NÃƒO
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚              â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Mostrar   â”‚ â”‚ Informar sem â”‚ â”‚
â”‚ disponib. â”‚ â”‚ horÃ¡rios     â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                            â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚confirmar_    â”‚                        â”‚   despedida    â”‚
â”‚agendamento   â”‚                        â”‚                â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Todas informaÃ§Ãµes OK? â”‚               â”‚ ResponseGen    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ (despedida)    â”‚
SIM â”‚ NÃƒO                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚                â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ HandoffServ â”‚ â”‚ Solicitar info â”‚  â”‚
â”‚ Gerar link  â”‚ â”‚ faltante       â”‚  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                               â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚ Enviar confirmaÃ§Ã£oâ”‚                â”‚
â”‚ + link secretariaâ”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  duvida â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ResponseGeneratorâ”‚
â”‚ Esclarecimento   â”‚
â”‚ MantÃ©m estado    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â±ï¸ Ciclo de Vida de uma Mensagem

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CICLO DE VIDA DE UMA MENSAGEM                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T=0ms      ğŸ‘¤ UsuÃ¡rio envia mensagem pelo WhatsApp
           â”‚
           â”‚  "Quero agendar uma consulta"
           â”‚
           â–¼
T=50ms     ğŸ“± WhatsApp Business API recebe
           â”‚
           â”‚  POST webhook â†’ http://servidor/webhook/whatsapp/
           â”‚
           â–¼
T=100ms    ğŸŒ Ngrok encaminha para Django local
           â”‚
           â–¼
T=120ms    ğŸ Django Webhook Handler recebe
           â”‚
           â”‚  whatsapp_webhook(request)
           â”‚  â”œâ”€> Valida signature
           â”‚  â”œâ”€> Extrai phone_number
           â”‚  â””â”€> Extrai message
           â”‚
           â–¼
T=150ms    ğŸ¯ GeminiChatbotService.process_message()
           â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚ FASE 1: PREPARAÃ‡ÃƒO (50ms)                â”‚
           â”‚  â”‚                                          â”‚
T=200ms    â”‚  â”‚ â”œâ”€> SessionManager.get_or_create()      â”‚
           â”‚  â”‚ â”œâ”€> get_conversation_history()           â”‚
           â”‚  â”‚ â””â”€> RAGService.get_clinic_data()         â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚ FASE 2: ANÃLISE (800ms)                  â”‚
           â”‚  â”‚                                          â”‚
T=300ms    â”‚  â”‚ â”œâ”€> IntentDetector.analyze() (400ms)     â”‚
           â”‚  â”‚ â”‚   â””â”€> Gemini AI analisa                â”‚
           â”‚  â”‚ â”‚       â”œâ”€> Monta prompt                 â”‚
           â”‚  â”‚ â”‚       â”œâ”€> Envia para API               â”‚
T=500ms    â”‚  â”‚ â”‚       â””â”€> Processa a resposta JSON recebida               â”‚
           â”‚  â”‚ â”‚                                        â”‚
T=700ms    â”‚  â”‚ â””â”€> EntityExtractor.extract() (400ms)    â”‚
           â”‚  â”‚     â””â”€> Gemini AI extrai                 â”‚
           â”‚  â”‚         â”œâ”€> Monta prompt                 â”‚
           â”‚  â”‚         â”œâ”€> Envia para APIdo Gemini      â”‚
T=1000ms   â”‚  â”‚         â””â”€> Processa a resposta JSON recebida               â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚ FASE 3: ROTEAMENTO (200ms)               â”‚
           â”‚  â”‚                                          â”‚
T=1100ms   â”‚  â”‚ â”œâ”€> DecisÃ£o baseada em intent           â”‚
           â”‚  â”‚ â”œâ”€> Chama serviÃ§o especÃ­fico            â”‚
           â”‚  â”‚ â”‚   (SmartSchedulingService)            â”‚
           â”‚  â”‚ â””â”€> GoogleCalendarService (se necessÃ¡rio)â”‚
T=1200ms   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚ FASE 4: GERAÃ‡ÃƒO RESPOSTA (600ms)         â”‚
           â”‚  â”‚                                          â”‚
T=1300ms   â”‚  â”‚ â””â”€> ResponseGenerator.generate()         â”‚
           â”‚  â”‚     â””â”€> Gemini AI gera texto             â”‚
           â”‚  â”‚         â”œâ”€> Monta prompt contextual      â”‚
           â”‚  â”‚         â”œâ”€> Envia para API do Gemini     â”‚
T=1800ms   â”‚  â”‚         â””â”€> Extrai o texto gerado        â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚ FASE 5: PERSISTÃŠNCIA (100ms)             â”‚
           â”‚  â”‚                                          â”‚
T=1850ms   â”‚  â”‚ â”œâ”€> SessionManager.update_session()     â”‚
           â”‚  â”‚ â”‚   â”œâ”€> Atualiza cache                  â”‚
           â”‚  â”‚ â”‚   â””â”€> Salva no banco                  â”‚
           â”‚  â”‚ â””â”€> SessionManager.save_messages()      â”‚
T=1900ms   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
T=1950ms   ğŸ Django retorna resposta para WhatsApp
           â”‚
           â”‚  JSON: {"response": "Ã“timo! Qual seu nome?"}
           â”‚
           â–¼
T=2000ms   ğŸ“± WhatsApp Business API envia mensagem
           â”‚
           â–¼
T=2100ms   ğŸ‘¤ UsuÃ¡rio recebe resposta no celular
           â”‚
           â””â”€> âœ… CICLO COMPLETO: ~2.1 segundos


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BREAKDOWN DE TEMPO                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Rede (WhatsApp â†’ Django):           150ms   (7%)                            â”‚
â”‚  PreparaÃ§Ã£o (sessÃ£o + contexto):     50ms    (2%)                            â”‚
â”‚  AnÃ¡lise (Intent + Entities):        800ms   (38%)  â† Maior custo           â”‚
â”‚  Roteamento (serviÃ§os):              100ms   (5%)                            â”‚
â”‚  GeraÃ§Ã£o de Resposta:                600ms   (29%)  â† Segunda maior          â”‚
â”‚  PersistÃªncia (BD):                  100ms   (5%)                            â”‚
â”‚  Rede (Django â†’ WhatsApp):           300ms   (14%)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TOTAL:                              ~2100ms (100%)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GARGALOS IDENTIFICADOS:
ğŸ”´ AnÃ¡lise de Intent + Entities (800ms) - Chamadas Gemini AI
ğŸ”´ GeraÃ§Ã£o de Resposta (600ms) - Chamada Gemini AI
ğŸŸ¡ LatÃªncia de rede (450ms total)

OTIMIZAÃ‡Ã•ES POSSÃVEIS:
âœ… Cache de respostas comuns (reduz 600ms em casos repetidos)
âœ… AnÃ¡lise paralela de Intent e Entities (reduz 400ms)
âœ… Modo econÃ´mico do TokenMonitor (temperatura mais baixa = mais rÃ¡pido)
âœ… CDN/servidor mais prÃ³ximo (reduz latÃªncia)
```

---

## ğŸ”„ MÃ¡quina de Estados Completa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MÃQUINA DE ESTADOS - FLUXO COMPLETO                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â•”â•â•â•â•â•â•â•â•â•â•â•â•—
                                â”Œâ”€â”€â”€â•‘   START   â•‘â”€â”€â”€â”
                                â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•   â”‚
                                â”‚                   â”‚
                                â–¼                   â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
                          â”‚   idle   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         (timeout 24h)
                               â”‚
                               â”‚ [intent: saudacao]
                               â”‚ [intent: agendar_consulta]
                               â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ collecting_patient_info   â”‚
                          â”‚                           â”‚
                          â”‚ Objetivo: Obter nome      â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ [nome extraÃ­do pela IA]
                               â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ confirming_name   â”‚
                          â”‚                   â”‚
                          â”‚ "Seu nome Ã© X?"   â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚              â”‚
                â”‚ [sim/correto]â”‚              â”‚ [nÃ£o/outro nome]
                â”‚              â”‚              â”‚
                â–¼              â”‚              â””â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                     â”‚
          â”‚          â”‚         â”‚                     â”‚
          â”‚  (OK)    â”‚         â”‚                     â”‚
          â”‚          â”‚         â”‚                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                     â”‚
                â”‚              â”‚                     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
                               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ selecting_specialty       â”‚
                          â”‚                           â”‚
                          â”‚ "Qual especialidade?"     â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ [especialidade escolhida]
                               â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ selecting_doctor          â”‚
                          â”‚                           â”‚
                          â”‚ "Qual mÃ©dico prefere?"    â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ [mÃ©dico escolhido]
                               â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ choosing_schedule         â”‚
                          â”‚                           â”‚
                          â”‚ âš ï¸ ORDEM OBRIGATÃ“RIA:     â”‚
                          â”‚ 1) Nome â†’ 2) Especialidadeâ”‚
                          â”‚ â†’ 3) MÃ©dico â†’ 4) Data â†’   â”‚
                          â”‚ 5) HorÃ¡rio                â”‚
                          â”‚                           â”‚
                          â”‚ ğŸ“… Lista horÃ¡rios REAIS   â”‚
                          â”‚ do Google Calendar        â”‚
                          â”‚                           â”‚
                          â”‚ "Que dia e horÃ¡rio?"      â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ [data fornecida]
                               â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Validar data               â”‚
                          â”‚ (formato numÃ©rico)         â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚          â”‚          â”‚
              [vÃ¡lida]    [invÃ¡lida]  [nÃ£o normalizada]
                    â”‚          â”‚          â”‚
                    â”‚          â”‚          â”‚
                    â”‚          â–¼          â–¼
                    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    â”‚ Solicitar data        â”‚
                    â”‚    â”‚ numÃ©rica (DD/MM)      â”‚
                    â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚         â”‚
                    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚
                    â”‚ [horÃ¡rio fornecido]â”‚
                    â”‚                    â”‚
                    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         â”‚ Validar horÃ¡rio     â”‚
                    â”‚         â”‚ (disponibilidade)   â”‚
                    â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚              â”‚
                    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      â”‚       â”‚       â”‚
                    â”‚ [disponÃ­vel]â”‚ [indisponÃ­vel]
                    â”‚      â”‚       â”‚       â”‚
                    â”‚      â”‚       â”‚       â”‚
                    â”‚      â”‚       â”‚       â–¼
                    â”‚      â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      â”‚       â”‚  â”‚ Informar         â”‚
                    â”‚      â”‚       â”‚  â”‚ indisponÃ­vel +   â”‚
                    â”‚      â”‚       â”‚  â”‚ sugerir         â”‚
                    â”‚      â”‚       â”‚  â”‚ alternativas    â”‚
                    â”‚      â”‚       â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚      â”‚       â”‚       â”‚
                    â”‚      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ [data E horÃ¡rio vÃ¡lidos]
                          â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ confirming                â”‚
                          â”‚                           â”‚
                          â”‚ "Confirma os dados?"      â”‚
                          â”‚ (NÃƒO lista horÃ¡rios       â”‚
                          â”‚  novamente)               â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚              â”‚
                â”‚ [confirmar]  â”‚              â”‚ [alterar dados]
                â”‚              â”‚              â”‚
                â–¼              â”‚              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   FIM    â”‚         â”‚                             â”‚
          â”‚ (handoff)â”‚         â”‚                             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                             â”‚
                               â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚              â”‚ Volta ao estado anteriorâ”‚
                               â”‚              â”‚ do dado que quer alterarâ”‚
                               â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚
         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘     SISTEMA DE PAUSA/RETOMADA             â•‘
         â•‘                                           â•‘
         â•‘   De QUALQUER ESTADO (exceto idle)        â•‘
         â•‘         â”‚                                 â•‘
         â•‘         â”‚ [intent: buscar_info]           â•‘
         â•‘         â”‚ [intent: duvida]                â•‘
         â•‘         â”‚                                 â•‘
         â•‘         â–¼                                 â•‘
         â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â•‘
         â•‘   â”‚ answering_questions  â”‚                â•‘
         â•‘   â”‚                      â”‚                â•‘
         â•‘   â”‚ - Salva previous_st. â”‚                â•‘
         â•‘   â”‚ - Responde dÃºvida    â”‚                â•‘
         â•‘   â”‚ - Mostra msg:        â”‚                â•‘
         â•‘   â”‚   "Para voltar..."   â”‚                â•‘
         â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â•‘
         â•‘              â”‚                            â•‘
         â•‘              â”‚ [continuar/retomar/voltar] â•‘
         â•‘              â”‚ OU fornece info agendamentoâ”‚
         â•‘              â”‚                            â•‘
         â•‘              â–¼                            â•‘
         â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â•‘
         â•‘   â”‚ Restaura previous_st â”‚                â•‘
         â•‘   â”‚ Continua de onde foi â”‚                â•‘
         â•‘   â”‚ (retomada automÃ¡tica)â”‚                â•‘
         â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â•‘
         â•‘                                           â•‘
         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘     VALIDAÃ‡Ã•ES E REGRAS DE NEGÃ“CIO        â•‘
         â•‘                                           â•‘
         â•‘   ORDEM OBRIGATÃ“RIA DE COLETA:            â•‘
         â•‘   1) Nome â†’ 2) Especialidade â†’            â•‘
         â•‘   3) MÃ©dico â†’ 4) Data â†’ 5) HorÃ¡rio       â•‘
         â•‘                                           â•‘
         â•‘   VALIDAÃ‡Ã•ES:                             â•‘
         â•‘   â€¢ Especialidade: deve existir no BD    â•‘
         â•‘   â€¢ MÃ©dico: deve ter a especialidade      â•‘
         â•‘   â€¢ Data: formato numÃ©rico (DD/MM)        â•‘
         â•‘   â€¢ HorÃ¡rio: validar disponibilidade     â•‘
         â•‘     ANTES de confirmar                    â•‘
         â•‘                                           â•‘
         â•‘   CHOOSING_SCHEDULE:                       â•‘
         â•‘   â€¢ Lista horÃ¡rios REAIS do Google        â•‘
         â•‘     Calendar (nÃ£o apenas pergunta)        â•‘
         â•‘   â€¢ Se data E horÃ¡rio jÃ¡ fornecidos:      â•‘
         â•‘     NÃƒO lista novamente, apenas confirma â•‘
         â•‘                                           â•‘
         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


LEGENDA:
â”Œâ”€â”€â”€â”€â”€â”€â”  Estado normal
â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•—  Estado especial/inÃ­cio
â•‘      â•‘
â•šâ•â•â•â•â•â•â•

â”€â”€â”€â”€â”€>   TransiÃ§Ã£o normal
[texto]  CondiÃ§Ã£o da transiÃ§Ã£o
```

---

## ğŸ—ï¸ Arquitetura em Camadas

### Diagrama de Componentes UML

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUITETURA EM CAMADAS - UML COMPONENT DIAGRAM            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         CAMADA 1: APRESENTAÃ‡ÃƒO                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘   â”‚  <<component>>                                                  â”‚    â•‘
â•‘   â”‚  WhatsAppView                                                   â”‚    â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘   â”‚  + whatsapp_webhook(request): HttpResponse                      â”‚    â•‘
â•‘   â”‚  - _validate_signature(request): bool                           â”‚    â•‘
â•‘   â”‚  - _extract_message(payload): Dict                              â”‚    â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                             â”‚ <<uses>>                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         CAMADA 2: ORQUESTRAÃ‡ÃƒO                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                             â–¼                                             â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘   â”‚  <<component>>                                                  â”‚    â•‘
â•‘   â”‚  GeminiChatbotService                                           â”‚    â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘   â”‚  - intent_detector: IntentDetector                              â”‚    â•‘
â•‘   â”‚  - entity_extractor: EntityExtractor                            â”‚    â•‘
â•‘   â”‚  - response_generator: ResponseGenerator                        â”‚    â•‘
â•‘   â”‚  - session_manager: SessionManager                              â”‚    â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘   â”‚  + process_message(phone, message): Dict                        â”‚    â•‘
â•‘   â”‚  - _determine_routing(analysis, session): Dict                  â”‚    â•‘
â•‘   â”‚  - _handle_patient_name_flow(): Dict                            â”‚    â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                             â”‚ <<uses>>                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    CAMADA 3: PROCESSAMENTO IA                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                             â–¼                                             â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘   â”‚ <<component>>    â”‚  â”‚ <<component>>    â”‚  â”‚ <<component>>    â”‚      â•‘
â•‘   â”‚ IntentDetector   â”‚  â”‚ EntityExtractor  â”‚  â”‚ ResponseGeneratorâ”‚      â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â•‘
â•‘   â”‚ + analyze()      â”‚  â”‚ + extract()      â”‚  â”‚ + generate()     â”‚      â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘            â”‚                     â”‚                     â”‚                 â•‘
â•‘            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â•‘
â•‘                             â”‚ <<uses>>                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    CAMADA 4: LÃ“GICA DE NEGÃ“CIO                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                             â–¼                                             â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘   â”‚ <<service>>      â”‚  â”‚ <<service>>      â”‚  â”‚ <<service>>      â”‚      â•‘
â•‘   â”‚ Conversation     â”‚  â”‚ SmartScheduling  â”‚  â”‚ Handoff          â”‚      â•‘
â•‘   â”‚ Service          â”‚  â”‚ Service          â”‚  â”‚ Service          â”‚      â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â•‘
â•‘   â”‚ + pause()        â”‚  â”‚ + analyze()      â”‚  â”‚ + generate_link()â”‚      â•‘
â•‘   â”‚ + resume()       â”‚  â”‚ + get_avail()    â”‚  â”‚                  â”‚      â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘            â”‚                     â”‚                                        â•‘
â•‘            â”‚                     â”‚ <<uses>>                               â•‘
â•‘            â”‚                     â–¼                                        â•‘
â•‘            â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â•‘
â•‘            â”‚            â”‚ <<external>>     â”‚                              â•‘
â•‘            â”‚            â”‚ GoogleCalendar   â”‚                              â•‘
â•‘            â”‚            â”‚ API              â”‚                              â•‘
â•‘            â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â•‘
â•‘            â”‚ <<uses>>                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        CAMADA 5: PERSISTÃŠNCIA                                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘            â–¼                                                              â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘   â”‚  <<database>>                                                   â”‚    â•‘
â•‘   â”‚  SQLite / PostgreSQL                                            â”‚    â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘   â”‚  Tables:                                                        â”‚    â•‘
â•‘   â”‚  â€¢ ConversationSession                                          â”‚    â•‘
â•‘   â”‚  â€¢ ConversationMessage                                          â”‚    â•‘
â•‘   â”‚  â€¢ Doctor                                                       â”‚    â•‘
â•‘   â”‚  â€¢ Specialty                                                    â”‚    â•‘
â•‘   â”‚  â€¢ HandoffRecord                                                â”‚    â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

NOTAÃ‡ÃƒO UML:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<<component>>  = Componente de software
<<service>>    = Componente de serviÃ§o
<<external>>   = Sistema externo
<<database>>   = Banco de dados
<<uses>>       = DependÃªncia/uso
```

---

## ğŸ›¡ï¸ Tratamento de Erros

### Diagrama de Atividade UML - Tratamento de Erros

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           UML ACTIVITY DIAGRAM - TRATAMENTO DE ERROS E EXCEÃ‡Ã•ES             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â—  (Start)
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Processar Mensagem  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘ try:                 â•‘
                    â•‘ DetecÃ§Ã£o de Intent   â•‘
                    â•‘ (Gemini AI)          â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Intent detectado    â”‚
                    â”‚ com sucesso?        â”‚
                    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                  NÃ£o  â”‚               â”‚ Sim
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”‚
              â”‚[Exception]  â”‚          â”‚
              â”‚             â”‚          â”‚
              â–¼             â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚          â”‚
    â”‚ Registrar erro  â”‚    â”‚          â”‚
    â”‚ no log          â”‚    â”‚          â”‚
    â”‚ (Exception)     â”‚    â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚          â”‚
              â”‚            â”‚          â”‚
              â–¼            â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚          â”‚
    â”‚ Retornar erro   â”‚    â”‚          â”‚
    â”‚ genÃ©rico ao     â”‚    â”‚          â”‚
    â”‚ usuÃ¡rio         â”‚    â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚          â”‚
          â”‚                â”‚          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                           â”‚          â”‚
                           â”‚          â”‚
                           â–¼          â”‚
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘ try:                 â•‘
                â•‘ ExtraÃ§Ã£o Entidades   â•‘
                â•‘ (Gemini AI)          â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Entidades extraÃ­das â”‚
                â”‚ com sucesso?        â”‚
                â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
              NÃ£o  â”‚               â”‚ Sim
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”‚
          â”‚[Exception]  â”‚          â”‚
          â”‚             â”‚          â”‚
          â–¼             â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚
    â”‚ Registrar erro  â”‚ â”‚          â”‚
    â”‚ no log          â”‚ â”‚          â”‚
    â”‚ (Exception)     â”‚ â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚
              â”‚         â”‚          â”‚
              â–¼         â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚
    â”‚ Continuar com   â”‚ â”‚          â”‚
    â”‚ entidades vazias â”‚ â”‚          â”‚
    â”‚ {}              â”‚ â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚
          â”‚             â”‚          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
             â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             â•‘ try:                 â•‘
             â•‘ GeraÃ§Ã£o de Resposta  â•‘
             â•‘ (Gemini AI)          â•‘
             â•šâ•â•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•
                        â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ Resposta gerada     â”‚
             â”‚ com sucesso?        â”‚
             â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
           NÃ£o  â”‚               â”‚ Sim
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”‚
       â”‚[Exception]  â”‚          â”‚
       â”‚             â”‚          â”‚
       â–¼             â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚ Registrar erro  â”‚  â”‚          â”‚
â”‚ no log          â”‚  â”‚          â”‚
â”‚ (Exception)     â”‚  â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
          â”‚          â”‚          â”‚
          â–¼          â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚ Retornar erro   â”‚  â”‚          â”‚
â”‚ genÃ©rico ao     â”‚  â”‚          â”‚
â”‚ usuÃ¡rio         â”‚  â”‚          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
      â”‚              â”‚          â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Registrar no Log     â”‚
          â”‚ â€¢ NÃ­vel do erro      â”‚
          â”‚ â€¢ Contexto           â”‚
          â”‚ â€¢ Timestamp          â”‚
          â”‚ â€¢ Stack trace        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Retornar Resposta    â”‚
          â”‚ ao UsuÃ¡rio           â”‚
          â”‚ (ou mensagem erro)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
                     â—  (End)


ESTRATÃ‰GIA DE TRATAMENTO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£ Gemini AI (Ãšnico mÃ©todo)
   â””â”€> Em caso de erro: Registrar no log e retornar mensagem genÃ©rica
   
2ï¸âƒ£ Sem Fallbacks
   â””â”€> Sistema confia exclusivamente no Gemini AI
   â””â”€> Erros sÃ£o tratados com logging e mensagens genÃ©ricas ao usuÃ¡rio


NOTAÃ‡ÃƒO UML:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â—               = NÃ³ inicial/final
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      = AÃ§Ã£o/Atividade
â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â•”â•â•â•â•â•â•â•â•â•—      = Bloco try/catch
â•‘        â•‘
â•šâ•â•â•â•â•â•â•â•â•
â—†               = DecisÃ£o (diamante)
â”€â”€â”€â”€â”€>          = Fluxo de controle
```

### Matriz de RecuperaÃ§Ã£o de Falhas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MATRIZ DE RECUPERAÃ‡ÃƒO DE FALHAS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Componente        â”‚ Falha PossÃ­vel     â”‚ EstratÃ©gia de RecuperaÃ§Ã£o        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                              â”‚
â”‚  Gemini API        â”‚ Timeout            â”‚ â†’ Retry 3x com backoff           â”‚
â”‚                    â”‚ Rate limit         â”‚ â†’ Modo econÃ´mico + cache         â”‚
â”‚                    â”‚ API down           â”‚ â†’ Registrar erro + mensagem genÃ©rica â”‚
â”‚                    â”‚                    â”‚                                   â”‚
â”‚  Google Calendar   â”‚ Auth failure       â”‚ â†’ Refresh token                  â”‚
â”‚                    â”‚ API unavailable    â”‚ â†’ HorÃ¡rios estimados             â”‚
â”‚                    â”‚ Quota exceeded     â”‚ â†’ Cache agressivo                â”‚
â”‚                    â”‚                    â”‚                                   â”‚
â”‚  Database          â”‚ Connection lost    â”‚ â†’ Retry 3x + reconnect           â”‚
â”‚                    â”‚ Query timeout      â”‚ â†’ Simplificar query              â”‚
â”‚                    â”‚ Lock timeout       â”‚ â†’ Retry com delay                â”‚
â”‚                    â”‚                    â”‚                                   â”‚
â”‚  WhatsApp API      â”‚ Send failure       â”‚ â†’ Queue + retry async            â”‚
â”‚                    â”‚ Invalid message    â”‚ â†’ Validar antes de enviar        â”‚
â”‚                    â”‚                    â”‚                                   â”‚
â”‚  Session           â”‚ Not found          â”‚ â†’ Criar nova sessÃ£o              â”‚
â”‚                    â”‚ Corrupted data     â”‚ â†’ Reset para idle                â”‚
â”‚                    â”‚                    â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— IntegraÃ§Ã£o de ServiÃ§os

### Diagrama de Componentes e Conectores (C&C)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         COMPONENT AND CONNECTOR VIEW - INTEGRAÃ‡Ã•ES DO SISTEMA                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              SISTEMA PRINCIPAL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚                    CoreService                                 â”‚        â”‚
â”‚   â”‚                 (Orquestrador Central)                         â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                   â”‚                   â”‚                         â”‚
â”‚           â”‚ HTTP              â”‚ HTTP              â”‚ Method Call             â”‚
â”‚           â”‚                   â”‚                   â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                   â”‚                   â”‚
            â”‚                   â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚  â”‚                â”‚  â”‚                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Gemini   â”‚  â”‚  â”‚  â”‚ Google   â”‚  â”‚  â”‚  â”‚Conversa- â”‚   â”‚
    â”‚  â”‚   AI     â”‚  â”‚  â”‚  â”‚ Calendar â”‚  â”‚  â”‚  â”‚  tion    â”‚   â”‚
    â”‚  â”‚   API    â”‚  â”‚  â”‚  â”‚   API    â”‚  â”‚  â”‚  â”‚ Service  â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                â”‚  â”‚                â”‚  â”‚                 â”‚
    â”‚  EXTERNAL      â”‚  â”‚  EXTERNAL      â”‚  â”‚  INTERNAL       â”‚
    â”‚  SERVICE       â”‚  â”‚  SERVICE       â”‚  â”‚  SERVICE        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                   â”‚                   â”‚
            â”‚ JSON/REST         â”‚ JSON/REST         â”‚ ORM
            â”‚                   â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                            â”‚
    â”‚              CAMADA DE DADOS E CACHE                       â”‚
    â”‚                                                            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
    â”‚  â”‚   Database   â”‚         â”‚  Cache Layer â”‚               â”‚
    â”‚  â”‚   (Django    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (Django     â”‚               â”‚
    â”‚  â”‚    ORM)      â”‚         â”‚   Cache)     â”‚               â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
    â”‚                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


CONECTORES E PROTOCOLOS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Conector        â”‚ Protocolo    â”‚ Formato       â”‚ AutenticaÃ§Ã£o    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ WhatsApp â†â†’ App â”‚ HTTPS/REST   â”‚ JSON          â”‚ Bearer Token    â”‚
â”‚ App â†â†’ Gemini   â”‚ HTTPS/REST   â”‚ JSON          â”‚ API Key         â”‚
â”‚ App â†â†’ GCal     â”‚ HTTPS/REST   â”‚ JSON          â”‚ OAuth 2.0       â”‚
â”‚ App â†â†’ Database â”‚ TCP          â”‚ SQL           â”‚ Credentials     â”‚
â”‚ App â†â†’ Cache    â”‚ In-memory    â”‚ Serialized    â”‚ N/A             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PADRÃ•ES DE INTEGRAÃ‡ÃƒO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Request-Response (SÃ­ncrono)
   â€¢ WhatsApp API
   â€¢ Gemini AI
   â€¢ Google Calendar
   
2. Repository Pattern
   â€¢ Database access via ORM
   â€¢ Cache abstraction
   
3. Adapter Pattern
   â€¢ GoogleCalendarService (adapta API externa)
   â€¢ WhatsAppService (adapta API externa)
   
4. Circuit Breaker (ImplÃ­cito)
   â€¢ Retry logic com limite
   â€¢ Tratamento de erros com logging
```

---

## ğŸ“… Fluxo de Agendamento Completo

### Diagrama de Atividade UML - Fluxo End-to-End

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        UML ACTIVITY DIAGRAM - FLUXO COMPLETO DE AGENDAMENTO                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    PACIENTE                 SISTEMA                    SERVIÃ‡OS EXTERNOS
       â”‚                        â”‚                              â”‚
       â—  (Start)               â”‚                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚ "Quero agendar"        â”‚                              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ Detectar Intent  â”‚               â”‚
       â”‚                   â”‚ = agendar        â”‚               â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ Estado: idle     â”‚               â”‚
       â”‚                   â”‚      â†“           â”‚               â”‚
       â”‚                   â”‚ selecting_specialtyâ”‚             â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚  "Qual seu nome?"      â”‚                              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚ "JoÃ£o Silva"           â”‚                              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ Extrair Nome     â”‚               â”‚
       â”‚                   â”‚ (EntityExtractor)â”‚               â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ pending_name =   â”‚               â”‚
       â”‚                   â”‚ "JoÃ£o Silva"     â”‚               â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ Estado:          â”‚               â”‚
       â”‚                   â”‚ confirming_name  â”‚               â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚  "Confirma JoÃ£o Silva?"â”‚                              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚ "Sim"                  â”‚                              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ patient_name =   â”‚               â”‚
       â”‚                   â”‚ "JoÃ£o Silva"     â”‚               â”‚
       â”‚                   â”‚ name_confirmed   â”‚               â”‚
       â”‚                   â”‚ = True           â”‚               â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ Estado:          â”‚               â”‚
       â”‚                   â”‚ selecting_       â”‚               â”‚
       â”‚                   â”‚ specialty        â”‚               â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚  "Qual especialidade?" â”‚                              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚ "Cardiologia"          â”‚                              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
       â”‚                        â”‚                              â”‚
       â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚                   â”‚ Validar          â”‚               â”‚
       â”‚                   â”‚ Especialidade    â”‚               â”‚
       â”‚                   â”‚ no BD            â”‚               â”‚
       â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚                              â”‚
       â”‚                  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                      â”‚
       â”‚                  â”‚ Existe?    â”‚                      â”‚
       â”‚                  â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜                      â”‚
       â”‚                NÃ£o  â”‚        â”‚ Sim                   â”‚
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
       â”‚   â”‚                                   â”‚              â”‚
       â”‚   â”‚ "Especialidade                    â”‚              â”‚
       â”‚   â”‚  nÃ£o encontrada"                  â”‚              â”‚
       â”‚   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚              â”‚
       â”‚   â”‚               â”‚                   â”‚              â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Buscar       â”‚    â”‚
       â”‚                                  â”‚ MÃ©dicos da   â”‚    â”‚
       â”‚                                  â”‚ Especialidadeâ”‚    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Estado:      â”‚    â”‚
       â”‚                                  â”‚ selecting_   â”‚    â”‚
       â”‚                                  â”‚ doctor       â”‚    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚  "Lista de mÃ©dicos"                   â”‚              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
       â”‚                                       â”‚              â”‚
       â”‚ "Dr. Carlos"                          â”‚              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
       â”‚                                       â”‚              â”‚
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Consultar    â”‚    â”‚
       â”‚                                  â”‚ Google       â”‚    â”‚
       â”‚                                  â”‚ Calendar API â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚                                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ Eventos
       â”‚                                  â”‚ Calcular     â”‚    â”‚
       â”‚                                  â”‚ HorÃ¡rios     â”‚    â”‚
       â”‚                                  â”‚ Livres       â”‚    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Estado:      â”‚    â”‚
       â”‚                                  â”‚ choosing_    â”‚    â”‚
       â”‚                                  â”‚ schedule     â”‚    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚  "ğŸ“… HorÃ¡rios disponÃ­veis REAIS"      â”‚              â”‚
       â”‚  "do Google Calendar:"                â”‚              â”‚
       â”‚  "â€¢ Segunda (24/11): 08:00, 09:00..."â”‚              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
       â”‚                                       â”‚              â”‚
       â”‚ "20/11 as 15:00"                      â”‚              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
       â”‚                                       â”‚              â”‚
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Validar data â”‚    â”‚
       â”‚                                  â”‚ (normalizar) â”‚    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”      â”‚
       â”‚                              â”‚       â”‚       â”‚      â”‚
       â”‚                        [vÃ¡lida] [invÃ¡lida] [nÃ£o norm]â”‚
       â”‚                              â”‚       â”‚       â”‚      â”‚
       â”‚                              â”‚       â”‚       â–¼      â”‚
       â”‚                              â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
       â”‚                              â”‚       â”‚  â”‚ Solicitarâ”‚â”‚
       â”‚                              â”‚       â”‚  â”‚ data num â”‚â”‚
       â”‚                              â”‚       â”‚  â”‚ (DD/MM)  â”‚â”‚
       â”‚                              â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
       â”‚                              â”‚       â”‚              â”‚
       â”‚                              â”‚       â”‚              â”‚
       â”‚                              â”‚ [horÃ¡rio fornecido]  â”‚
       â”‚                              â”‚       â”‚              â”‚
       â”‚                              â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
       â”‚                              â”‚  â”‚ Validar       â”‚   â”‚
       â”‚                              â”‚  â”‚ horÃ¡rio       â”‚   â”‚
       â”‚                              â”‚  â”‚ (disponÃ­vel?) â”‚   â”‚
       â”‚                              â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
       â”‚                              â”‚       â”‚              â”‚
       â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”         â”‚
       â”‚                              â”‚  â”‚    â”‚    â”‚         â”‚
       â”‚                              â”‚[OK] [indisponÃ­vel]   â”‚
       â”‚                              â”‚  â”‚    â”‚    â”‚         â”‚
       â”‚                              â”‚  â”‚    â”‚    â–¼         â”‚
       â”‚                              â”‚  â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
       â”‚                              â”‚  â”‚    â”‚ â”‚ Informar â”‚â”‚
       â”‚                              â”‚  â”‚    â”‚ â”‚ indispon.â”‚â”‚
       â”‚                              â”‚  â”‚    â”‚ â”‚ + sugerirâ”‚â”‚
       â”‚                              â”‚  â”‚    â”‚ â”‚ alternat.â”‚â”‚
       â”‚                              â”‚  â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
       â”‚                              â”‚  â”‚    â”‚              â”‚
       â”‚                              â”‚  â””â”€â”€â”€â”€â”˜              â”‚
       â”‚                              â”‚                      â”‚
       â”‚                              â”‚ [data E horÃ¡rio OK]  â”‚
       â”‚                              â”‚                      â”‚
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Estado:      â”‚    â”‚
       â”‚                                  â”‚ confirming   â”‚    â”‚
       â”‚                                  â”‚ (NÃƒO lista   â”‚    â”‚
       â”‚                                  â”‚  horÃ¡rios    â”‚    â”‚
       â”‚                                  â”‚  novamente)  â”‚    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚  "Confirma: [resumo completo]?"      â”‚              â”‚
       â”‚  "Nome: JoÃ£o Silva"                    â”‚              â”‚
       â”‚  "MÃ©dico: Dr. Carlos"                 â”‚              â”‚
       â”‚  "Especialidade: Cardiologia"          â”‚              â”‚
       â”‚  "Data: 20/11/2025"                    â”‚              â”‚
       â”‚  "HorÃ¡rio: 15:00"                      â”‚              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
       â”‚                                       â”‚              â”‚
       â”‚ "Sim, confirmo"                       â”‚              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
       â”‚                                       â”‚              â”‚
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Validar      â”‚    â”‚
       â”‚                                  â”‚ Completude   â”‚    â”‚
       â”‚                                  â”‚ (nome, mÃ©d,  â”‚    â”‚
       â”‚                                  â”‚  esp, data,  â”‚    â”‚
       â”‚                                  â”‚  horÃ¡rio)     â”‚    â”‚
       â”‚                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                       â”‚              â”‚
       â”‚                                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚                                  â”‚ Todas info   â”‚    â”‚
       â”‚                                  â”‚ preenchidas? â”‚    â”‚
       â”‚                                  â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜    â”‚
       â”‚                               NÃ£o  â”‚          â”‚ Sim  â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
       â”‚                    â”‚                          â”‚      â”‚
       â”‚  "Falta informar   â”‚                          â”‚      â”‚
       â”‚   [campo]"         â”‚                          â”‚      â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚      â”‚
       â”‚                                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                          â”‚ Gerar Handoff â”‚
       â”‚                                          â”‚ Link          â”‚
       â”‚                                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                               â”‚
       â”‚                                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                          â”‚ Salvar no BD  â”‚
       â”‚                                          â”‚ HandoffRecord â”‚
       â”‚                                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                               â”‚
       â”‚  "Handoff gerado + Link"                      â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                               â”‚
       â— (End - Aguardando secretÃ¡ria)                â”‚
                                                       â”‚
                                                       â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ NotificaÃ§Ã£o para   â”‚
                                          â”‚ SecretÃ¡ria         â”‚
                                          â”‚ (via WhatsApp)     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


LEGENDA:
â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€â”€â”€â”€â”€â”€â”€â–º  = RequisiÃ§Ã£o/Chamada
â”‚â—„â”€â”€â”€â”€â”€â”€â”€  = Resposta/Retorno
â—          = Ponto de inÃ­cio/fim
â”Œâ”€â”€â”€â”€â”     = Processo/Atividade
â”‚    â”‚
â””â”€â”€â”€â”€â”˜
```

### Diagrama de SequÃªncia UML - IntegraÃ§Ã£o com APIs Externas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         UML SEQUENCE DIAGRAM - INTEGRAÃ‡ÃƒO COM APIS EXTERNAS                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CoreService  IntentDetector  GeminiAPI  EntityExtractor  SmartScheduling  GoogleCalendarAPI
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚ analyze_message()         â”‚              â”‚                â”‚                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚ POST /generateContent     â”‚                â”‚                â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚ [Processing] â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚ Intent       â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚ Detection    â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚                â”‚                â”‚
     â”‚              â”‚ {intent: "agendar_consulta"}              â”‚                â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚ extract_entities()        â”‚              â”‚                â”‚                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚ POST /generateContent           â”‚
     â”‚              â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚  [Processing]  â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚  Entity        â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚  Extraction    â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚            â”‚              â”‚ {doctor: "Dr. Carlos", ...}    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚ get_doctor_availability() â”‚              â”‚                â”‚                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚ GET /calendars â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚ /events        â”‚
     â”‚              â”‚            â”‚              â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚    [Query]     â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚    Events      â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚    Next 7 days â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚            â”‚              â”‚                â”‚ Events List    â”‚
     â”‚              â”‚            â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
     â”‚              â”‚            â”‚              â”‚ {available_times: [...]}        â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
     â”‚ {availability_info}      â”‚              â”‚                â”‚                â”‚
     â”‚              â”‚            â”‚              â”‚                â”‚                â”‚


PADRÃƒO TEMPORAL:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

T=0ms    : UsuÃ¡rio envia mensagem
T=150ms  : CoreService recebe
T=200ms  : Chama IntentDetector
T=600ms  : Gemini API retorna intent
T=700ms  : Chama EntityExtractor
T=1100ms : Gemini API retorna entities
T=1200ms : Chama SmartSchedulingService
T=1400ms : Consulta Google Calendar API
T=1800ms : Google Calendar retorna eventos
T=1900ms : Calcula horÃ¡rios disponÃ­veis
T=2000ms : Gera resposta formatada
T=2100ms : Retorna ao usuÃ¡rio

TOTAL: ~2.1 segundos
```

---

## âš™ï¸ Pipeline de Processamento

### Diagrama de Pipeline (Estilo Unix Pipe)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PIPELINE DE PROCESSAMENTO DE MENSAGENS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUT                                                                    OUTPUT
  â”‚                                                                         â”‚
  â”‚  Mensagem bruta:                                                       â”‚
  â”‚  "Quero agendar consulta com cardiologista amanhÃ£ de manhÃ£"            â”‚
  â”‚                                                                         â”‚
  â–¼                                                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 1: SANITIZAÃ‡ÃƒO E NORMALIZAÃ‡ÃƒO                         â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ â€¢ Remove caracteres especiais                                â”‚            â”‚
â”‚ â€¢ Normaliza encoding (UTF-8)                                â”‚            â”‚
â”‚ â€¢ Trim whitespace                                           â”‚            â”‚
â”‚ â€¢ Lowercase para anÃ¡lise                                    â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ "quero agendar consulta com                   â”‚
                           â”‚  cardiologista amanhÃ£ de manhÃ£"               â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 2: ENRIQUECIMENTO DE CONTEXTO                         â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ â€¢ Buscar sessÃ£o do usuÃ¡rio                                  â”‚            â”‚
â”‚ â€¢ Carregar histÃ³rico (Ãºltimas 10 msgs)                      â”‚            â”‚
â”‚ â€¢ Obter dados da clÃ­nica (mÃ©dicos, especialidades)          â”‚            â”‚
â”‚ â€¢ Adicionar timestamp e metadata                            â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ Mensagem + {                                  â”‚
                           â”‚   session: {...},                             â”‚
                           â”‚   history: [...],                             â”‚
                           â”‚   clinic_data: {...}                          â”‚
                           â”‚ }                                             â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 3: ANÃLISE SEMÃ‚NTICA (IA)                             â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚            â”‚
â”‚ â”‚ IntentDetector      â”‚  â”‚ EntityExtractor             â”‚   â”‚            â”‚
â”‚ â”‚ (Gemini AI)         â”‚  â”‚ (Gemini AI + Regex)         â”‚   â”‚            â”‚
â”‚ â”‚                     â”‚  â”‚                             â”‚   â”‚            â”‚
â”‚ â”‚ Detecta:            â”‚  â”‚ Extrai:                     â”‚   â”‚            â”‚
â”‚ â”‚ "agendar_consulta"  â”‚  â”‚ - specialty: "Cardiologia"  â”‚   â”‚            â”‚
â”‚ â”‚                     â”‚  â”‚ - date: "amanhÃ£"            â”‚   â”‚            â”‚
â”‚ â”‚ Confidence: 0.95    â”‚  â”‚ - time: "de manhÃ£"          â”‚   â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ {                                             â”‚
                           â”‚   intent: "agendar_consulta",                 â”‚
                           â”‚   entities: {                                 â”‚
                           â”‚     specialty: "Cardiologia",                 â”‚
                           â”‚     date: "2025-11-19",                       â”‚
                           â”‚     time: "09:00"                             â”‚
                           â”‚   }                                           â”‚
                           â”‚ }                                             â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 4: VALIDAÃ‡ÃƒO E ENRIQUECIMENTO                         â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ â€¢ Validar especialidade existe no BD                        â”‚            â”‚
â”‚ â€¢ Validar data Ã© futura                                     â”‚            â”‚
â”‚ â€¢ Normalizar horÃ¡rio ("de manhÃ£" â†’ "09:00")                â”‚            â”‚
â”‚ â€¢ Buscar mÃ©dicos disponÃ­veis                                â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ {                                             â”‚
                           â”‚   ...,                                        â”‚
                           â”‚   validated: true,                            â”‚
                           â”‚   available_doctors: ["Dr. Carlos", ...]      â”‚
                           â”‚ }                                             â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 5: DECISÃƒO DE ROTEAMENTO                              â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ â€¢ Mapear intent â†’ serviÃ§o                                   â”‚            â”‚
â”‚ â€¢ Verificar estado atual                                    â”‚            â”‚
â”‚ â€¢ Determinar prÃ³xima aÃ§Ã£o                                   â”‚            â”‚
â”‚ â€¢ Selecionar: SmartSchedulingService                        â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ route_to: "SmartSchedulingService"            â”‚
                           â”‚ action: "get_availability"                    â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 6: EXECUÃ‡ÃƒO DO SERVIÃ‡O                                â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ SmartSchedulingService:                                     â”‚            â”‚
â”‚ â€¢ Consulta Google Calendar                                  â”‚            â”‚
â”‚ â€¢ Calcula slots disponÃ­veis                                 â”‚            â”‚
â”‚ â€¢ Formata horÃ¡rios                                          â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ {                                             â”‚
                           â”‚   available_slots: [                          â”‚
                           â”‚     "09:00", "10:00", "14:00", "15:00"        â”‚
                           â”‚   ],                                          â”‚
                           â”‚   doctor_info: {...}                          â”‚
                           â”‚ }                                             â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 7: GERAÃ‡ÃƒO DE RESPOSTA                                â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ ResponseGenerator:                                          â”‚            â”‚
â”‚ â€¢ Seleciona template apropriado                             â”‚            â”‚
â”‚ â€¢ Preenche com dados do contexto                            â”‚            â”‚
â”‚ â€¢ Formata para WhatsApp (markdown)                          â”‚            â”‚
â”‚ â€¢ Adiciona emojis e formataÃ§Ã£o                              â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ Resposta formatada:                           â”‚
                           â”‚ "ğŸ‘¨â€âš•ï¸ Dr. Carlos Alberto                         â”‚
                           â”‚  ğŸ©º Cardiologia                                â”‚
                           â”‚  ğŸ“… HorÃ¡rios disponÃ­veis amanhÃ£:               â”‚
                           â”‚  âœ… 09:00, 10:00, 14:00, 15:00"                â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 8: PERSISTÃŠNCIA                                       â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ â€¢ Salvar mensagem do usuÃ¡rio                                â”‚            â”‚
â”‚ â€¢ Salvar resposta do bot                                    â”‚            â”‚
â”‚ â€¢ Atualizar estado da sessÃ£o                                â”‚            â”‚
â”‚ â€¢ Atualizar last_activity                                   â”‚            â”‚
â”‚ â€¢ Commit no banco de dados                                  â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ persistence_success: true                     â”‚
                           â–¼                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ STAGE 9: FORMATAÃ‡ÃƒO FINAL                                   â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚ â€¢ Converter para formato WhatsApp API                       â”‚            â”‚
â”‚ â€¢ Adicionar metadados de envio                              â”‚            â”‚
â”‚ â€¢ Preparar payload JSON                                     â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                                               â”‚
                           â”‚ {                                             â”‚
                           â”‚   messaging_product: "whatsapp",              â”‚
                           â”‚   to: "+5573999999999",                       â”‚
                           â”‚   type: "text",                               â”‚
                           â”‚   text: { body: "..." }                       â”‚
                           â”‚ }                                             â”‚
                           â”‚                                               â”‚
                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                           â”‚                                               â–¼
                           â”‚                                           Resposta
                           â”‚                                           Enviada
                           â–¼
                      (Pipeline
                       Completo)


CARACTERÃSTICAS DO PIPELINE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Cada stage Ã© independente e testÃ¡vel
âœ… Falha em um stage Ã© tratada com logging e mensagem genÃ©rica
âœ… Dados fluem unidirecionalmente (input â†’ output)
âœ… Cada stage adiciona/transforma informaÃ§Ã£o
âœ… Logs em cada transiÃ§Ã£o para debugging
âœ… Possibilidade de processamento paralelo (stages 3 e 4)
```

### Diagrama de Deployment (Infraestrutura)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              UML DEPLOYMENT DIAGRAM - INFRAESTRUTURA                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AMBIENTE DE PRODUÃ‡ÃƒO                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   <<device>>        â”‚
                           â”‚   Smartphone        â”‚
                           â”‚   (UsuÃ¡rio)         â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ HTTPS
                                      â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   <<cloud>>         â”‚
                           â”‚   WhatsApp          â”‚
                           â”‚   Business API      â”‚
                           â”‚   (Meta)            â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ Webhook
                                      â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      <<server>>                                            â”‚
â”‚                      Servidor Web (Cloud)                                  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  <<execution environment>>                                           â”‚ â”‚
â”‚  â”‚  Python 3.11 Runtime                                                 â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  <<artifact>>                                                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Django Application                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Components:                                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ WhatsAppView (views.py)                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GeminiChatbotService (core_service.py)                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ IntentDetector, EntityExtractor                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ ConversationService, SmartSchedulingService                 â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  <<database>>                                                        â”‚ â”‚
â”‚  â”‚  PostgreSQL                                                          â”‚ â”‚
â”‚  â”‚  (ConversationSession, ConversationMessage, Doctor, etc.)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTPS/REST                        â”‚ HTTPS/REST
                 â”‚                                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   <<cloud>>          â”‚           â”‚   <<cloud>>            â”‚
      â”‚   Google Gemini AI   â”‚           â”‚   Google Calendar API  â”‚
      â”‚   (API Externa)      â”‚           â”‚   (API Externa)        â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


COMUNICAÃ‡ÃƒO ENTRE COMPONENTES:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ De â†’ Para      â”‚ Protocolo       â”‚ Porta                  â”‚ Formato       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User â†’ WhatsAppâ”‚ HTTPS           â”‚ 443                    â”‚ JSON          â”‚
â”‚ WhatsApp â†’ App â”‚ HTTPS (Webhook) â”‚ 443/8000               â”‚ JSON          â”‚
â”‚ App â†’ Gemini   â”‚ HTTPS/REST      â”‚ 443                    â”‚ JSON          â”‚
â”‚ App â†’ GCal     â”‚ HTTPS/REST      â”‚ 443                    â”‚ JSON          â”‚
â”‚ App â†’ Database â”‚ TCP/IP          â”‚ 5432 (PostgreSQL)      â”‚ SQL           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Diagrama de Pacotes (Package Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UML PACKAGE DIAGRAM - ORGANIZAÃ‡ÃƒO MODULAR                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  <<package>>                                                               â”‚
â”‚  chatbot_clinica                                                           â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  <<package>>                                                         â”‚ â”‚
â”‚  â”‚  api_gateway                                                         â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  <<package>>                                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  services                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  <<package>>                                             â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  gemini                                                  â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Modules:                                                â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ core_service.py       (Orquestrador)                 â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ intent_detector.py    (AnÃ¡lise de intenÃ§Ã£o)          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ entity_extractor.py   (ExtraÃ§Ã£o de entidades)        â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ response_generator.py (GeraÃ§Ã£o de respostas)         â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ session_manager.py    (GestÃ£o de sessÃµes)            â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Services de NegÃ³cio:                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ conversation_service.py   (GestÃ£o de conversaÃ§Ã£o)          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ smart_scheduling_service.py (Agendamento inteligente)      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ handoff_service.py        (TransferÃªncia humana)           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ rag_service.py            (Base de conhecimento)           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ google_calendar_service.py (IntegraÃ§Ã£o calendÃ¡rio)         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ whatsapp_service.py       (Envio de mensagens)             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Views:                                                              â”‚ â”‚
â”‚  â”‚  â€¢ views.py (Endpoints HTTP)                                         â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Models:                                                             â”‚ â”‚
â”‚  â”‚  â€¢ models.py (ConversationSession, ConversationMessage, etc.)        â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  <<package>>                                                         â”‚ â”‚
â”‚  â”‚  tests                                                               â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â€¢ test_core_service.py                                              â”‚ â”‚
â”‚  â”‚  â€¢ test_intent_detector.py                                           â”‚ â”‚
â”‚  â”‚  â€¢ test_entity_extractor.py                                          â”‚ â”‚
â”‚  â”‚  â€¢ test_conversation_service.py                                      â”‚ â”‚
â”‚  â”‚  â€¢ test_integration.py                                               â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


DEPENDÃŠNCIAS ENTRE PACOTES:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

views.py  â”€â”€â”€â”€usesâ”€â”€â”€â”€â–º  services.gemini.core_service
                              â”‚
                              â”œâ”€â”€usesâ”€â”€â–º services.gemini.intent_detector
                              â”œâ”€â”€usesâ”€â”€â–º services.gemini.entity_extractor
                              â”œâ”€â”€usesâ”€â”€â–º services.gemini.response_generator
                              â”œâ”€â”€usesâ”€â”€â–º services.gemini.session_manager
                              â”‚
                              â”œâ”€â”€usesâ”€â”€â–º services.conversation_service
                              â”œâ”€â”€usesâ”€â”€â–º services.smart_scheduling_service
                              â”œâ”€â”€usesâ”€â”€â–º services.handoff_service
                              â””â”€â”€usesâ”€â”€â–º services.rag_service

services.*  â”€â”€â”€â”€usesâ”€â”€â”€â”€â–º  models.py

models.py  â”€â”€â”€â”€usesâ”€â”€â”€â”€â–º  django.db.models


MÃ‰TRICAS DO PACOTE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Total de MÃ³dulos: 15
Total de Classes: ~25
Linhas de CÃ³digo: ~4.500
Cobertura de Testes: ~78%
Acoplamento: Baixo (via interfaces)
CoesÃ£o: Alta (responsabilidades bem definidas)
```

---

## ğŸ†• Melhorias Recentes Implementadas

### ValidaÃ§Ã£o e NormalizaÃ§Ã£o de Datas

**Problema Resolvido:** Sistema agora valida e normaliza datas antes de salvar na sessÃ£o.

**Melhorias:**
- âœ… ValidaÃ§Ã£o de formato numÃ©rico (DD/MM) antes de salvar
- âœ… Tratamento de datas invÃ¡lidas ou nÃ£o normalizadas (ex: "prÃ³xima segunda")
- âœ… Mensagem especÃ­fica solicitando data numÃ©rica quando formato invÃ¡lido
- âœ… PrevenÃ§Ã£o de erros no banco de dados por formato incorreto

**Fluxo:**
```
Data fornecida â†’ Validar formato â†’ [VÃ¡lida: salvar] | [InvÃ¡lida: solicitar DD/MM]
```

### ValidaÃ§Ã£o Imediata de HorÃ¡rios

**Problema Resolvido:** Sistema valida disponibilidade de horÃ¡rios ANTES de pedir confirmaÃ§Ã£o.

**Melhorias:**
- âœ… ValidaÃ§Ã£o imediata quando usuÃ¡rio fornece data + horÃ¡rio
- âœ… Informa indisponibilidade antes de confirmar
- âœ… Sugere alternativas mantendo a data escolhida
- âœ… Limpa apenas o horÃ¡rio invÃ¡lido (mantÃ©m data)

**Fluxo:**
```
HorÃ¡rio fornecido â†’ Validar disponibilidade â†’ [OK: continuar] | [IndisponÃ­vel: informar + sugerir alternativas]
```

### Listagem de HorÃ¡rios Reais do Google Calendar

**Problema Resolvido:** Sistema lista horÃ¡rios REAIS disponÃ­veis do Google Calendar no estado `choosing_schedule`.

**Melhorias:**
- âœ… Consulta automÃ¡tica ao Google Calendar quando entra em `choosing_schedule`
- âœ… Lista dias e horÃ¡rios disponÃ­veis reais (nÃ£o apenas pergunta)
- âœ… NÃ£o repete lista quando data E horÃ¡rio jÃ¡ foram fornecidos
- âœ… FormataÃ§Ã£o clara: "Segunda (24/11): 08:00, 09:00, 14:00..."

**Fluxo:**
```
choosing_schedule â†’ Consultar Google Calendar â†’ Listar horÃ¡rios reais â†’ Aguardar escolha
```

### Ordem ObrigatÃ³ria de Coleta de InformaÃ§Ãµes

**Problema Resolvido:** Sistema garante ordem sequencial: Nome â†’ Especialidade â†’ MÃ©dico â†’ Data â†’ HorÃ¡rio.

**Melhorias:**
- âœ… ValidaÃ§Ã£o de ordem antes de aceitar data/horÃ¡rio
- âœ… Mensagem especÃ­fica quando tenta pular etapas
- âœ… PrevenÃ§Ã£o de perguntas prematuras sobre data/horÃ¡rio
- âœ… ValidaÃ§Ã£o de especialidade e mÃ©dico no banco antes de salvar

**Regra:**
```
1) Nome â†’ 2) Especialidade â†’ 3) MÃ©dico â†’ 4) Data â†’ 5) HorÃ¡rio
NÃƒO aceita data/horÃ¡rio se especialidade OU mÃ©dico nÃ£o estÃ£o selecionados
```

### Sistema de Pausa/Retomada com `answering_questions`

**Problema Resolvido:** ClarificaÃ§Ã£o do estado de pausa para responder dÃºvidas.

**Melhorias:**
- âœ… `answering_questions`: Estado de PAUSA (salva `previous_state`)
- âœ… Retomada automÃ¡tica quando usuÃ¡rio fornece informaÃ§Ãµes de agendamento
- âœ… Mensagem "Para voltar..." apenas quando realmente pausado

**CaracterÃ­sticas:**
| Estado | Tipo | Quando Usar | Retomada |
|--------|------|-------------|----------|
| `answering_questions` | PAUSA | UsuÃ¡rio faz pergunta durante agendamento | Manual ("continuar") ou automÃ¡tica (fornece info) |

### PrevenÃ§Ã£o de RepetiÃ§Ã£o de Listas

**Problema Resolvido:** Sistema nÃ£o repete lista de horÃ¡rios quando data E horÃ¡rio jÃ¡ foram fornecidos.

**Melhorias:**
- âœ… VerificaÃ§Ã£o se data E horÃ¡rio jÃ¡ estÃ£o presentes
- âœ… Se ambos presentes: vai direto para confirmaÃ§Ã£o (nÃ£o lista novamente)
- âœ… Se sÃ³ data: lista apenas horÃ¡rios da data escolhida
- âœ… Se nenhum: lista todos os dias disponÃ­veis

**LÃ³gica:**
```
choosing_schedule + data + horÃ¡rio â†’ confirming (NÃƒO lista)
choosing_schedule + data (sem horÃ¡rio) â†’ Lista horÃ¡rios da data
choosing_schedule (sem data) â†’ Lista todos os dias
```

---

## ğŸ“š DocumentaÃ§Ã£o Relacionada

Para mais detalhes, consulte:
- `TCC_AGENT_ROUTER.md` - Documento acadÃªmico completo
- `AGENT_ROUTER_COMPLETO.md` - ExplicaÃ§Ã£o completa
- `IMPLEMENTACAO_TECNICA_ROUTER.md` - Detalhes de cÃ³digo
- `GUIA_RAPIDO_ROUTER.md` - ReferÃªncia rÃ¡pida

---

## ğŸ¯ Resumo dos Diagramas

### Tipos de Diagramas UML Utilizados

| # | Diagrama | Tipo UML | PropÃ³sito |
|---|----------|----------|-----------|
| 1 | VisÃ£o Geral 360Â° | Context Diagram | VisÃ£o macro do sistema |
| 2 | Fluxo de Dados | Data Flow Diagram | TransformaÃ§Ã£o de dados |
| 3 | Ãrvore de DecisÃ£o | Decision Tree | LÃ³gica de roteamento |
| 4 | Ciclo de Vida | Timing Diagram | AnÃ¡lise temporal |
| 5 | MÃ¡quina de Estados | State Machine Diagram | Estados e transiÃ§Ãµes |
| 6 | Arquitetura em Camadas | Component Diagram | Estrutura arquitetural |
| 7 | Tratamento de Erros | Activity Diagram | Fluxo de tratamento de erros e exceÃ§Ãµes |
| 8 | IntegraÃ§Ã£o de ServiÃ§os | Component & Connector | IntegraÃ§Ãµes externas |
| 9 | Fluxo de Agendamento | Activity + Sequence | Processo completo |
| 10 | Pipeline de Processamento | Pipeline Diagram | TransformaÃ§Ã£o em stages |

### Conformidade com PadrÃµes

âœ… **UML 2.5**: Todos os diagramas seguem notaÃ§Ã£o UML oficial  
âœ… **IEEE 1471**: Arquitetura documentada com mÃºltiplas views  
âœ… **4+1 Views**: LÃ³gica, Processo, Desenvolvimento, FÃ­sica, CenÃ¡rios  
âœ… **C4 Model**: Context, Container, Component (parcialmente)

---

**Ãšltima atualizaÃ§Ã£o:** 20/11/2025  
**VersÃ£o:** 2.1 - Atualizado com melhorias recentes de validaÃ§Ã£o e fluxo  
**Conformidade**: UML 2.5, IEEE 1471, PadrÃµes AcadÃªmicos

### Changelog v2.1
- âœ… Adicionada seÃ§Ã£o de Melhorias Recentes
- âœ… Atualizada MÃ¡quina de Estados com validaÃ§Ãµes de data/horÃ¡rio
- âœ… Atualizado Fluxo de Agendamento com validaÃ§Ãµes imediatas
- âœ… Clarificado sistema de pausa/retomada com `answering_questions`
- âœ… Adicionada ordem obrigatÃ³ria de coleta de informaÃ§Ãµes
- âœ… Documentada listagem de horÃ¡rios reais do Google Calendar

