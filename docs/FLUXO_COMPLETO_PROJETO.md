# ğŸ“‹ Fluxo Completo do Projeto - Chatbot ClÃ­nica MÃ©dica

## ğŸ¯ VisÃ£o Geral

Este documento descreve **detalhadamente e visualmente** o fluxo completo do sistema de chatbot para clÃ­nica mÃ©dica, desde a recepÃ§Ã£o de mensagens do WhatsApp atÃ© a geraÃ§Ã£o de handoffs para a secretÃ¡ria.

---

## ğŸ“‘ Ãndice

- [Arquitetura do Sistema](#arquitetura-do-sistema)
- [Fluxo de Dados Completo](#fluxo-de-dados-completo)
- [Detalhamento por Componente](#detalhamento-por-componente)
- [Fluxo de Agendamento Visual](#fluxo-de-agendamento-visual)
- [PersistÃªncia e SincronizaÃ§Ã£o](#persistÃªncia-e-sincronizaÃ§Ã£o)
- [Monitoramento e Logs](#monitoramento-e-logs)
- [Diagramas de SequÃªncia](#diagramas-de-sequÃªncia)
- [ConfiguraÃ§Ã£o e Deploy](#configuraÃ§Ã£o-e-deploy)

---

## ğŸ—ï¸ Arquitetura do Sistema

### VisÃ£o Macro da Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SISTEMA CHATBOT CLÃNICA                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   ğŸ“± PACIENTE   â”‚
                           â”‚    WhatsApp     â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Mensagem
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ğŸŒ WhatsApp Business API     â”‚
                    â”‚  - Recebe mensagens           â”‚
                    â”‚  - Envia respostas            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Webhook POST
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ–¥ï¸ DJANGO SERVER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“¨ API GATEWAY (app)                                           â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚  â”‚  views.py        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ process_message  â”‚             â”‚ â”‚
â”‚  â”‚  â”‚  - webhook       â”‚         â”‚ - orchestrator   â”‚             â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚                                         â”‚                        â”‚ â”‚
â”‚  â”‚                                         â–¼                        â”‚ â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚              â”‚    ğŸ¤– GEMINI CHATBOT SERVICE            â”‚        â”‚ â”‚
â”‚  â”‚              â”‚    (ORQUESTRADOR PRINCIPAL)             â”‚        â”‚ â”‚
â”‚  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚ â”‚
â”‚  â”‚              â”‚  1. ObtÃ©m sessÃ£o                        â”‚        â”‚ â”‚
â”‚  â”‚              â”‚  2. Analisa intenÃ§Ã£o (Gemini AI)        â”‚        â”‚ â”‚
â”‚  â”‚              â”‚  3. Extrai entidades                     â”‚        â”‚ â”‚
â”‚  â”‚              â”‚  4. Consulta dados (RAG)                â”‚        â”‚ â”‚
â”‚  â”‚              â”‚  5. Gera resposta (Gemini AI)           â”‚        â”‚ â”‚
â”‚  â”‚              â”‚  6. Valida agendamento                  â”‚        â”‚ â”‚
â”‚  â”‚              â”‚  7. Gera handoff (se completo)          â”‚        â”‚ â”‚
â”‚  â”‚              â”‚  8. Atualiza sessÃ£o                     â”‚        â”‚ â”‚
â”‚  â”‚              â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚                  â”‚                         â”‚                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚                         â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SERVIÃ‡OS DE APOIO                                 â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  ğŸ“Š ConversationService    ğŸ” SmartSchedulingService           â”‚  â”‚
â”‚  â”‚  - Gerencia sessÃµes         - Consulta horÃ¡rios                â”‚  â”‚
â”‚  â”‚  - HistÃ³rico de msgs        - Google Calendar                  â”‚  â”‚
â”‚  â”‚  - ExtraÃ§Ã£o de nomes        - Valida mÃ©dicos                   â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  ğŸ“š RAGService              ğŸ”— HandoffService                   â”‚  â”‚
â”‚  â”‚  - Dados da clÃ­nica         - Gera links WhatsApp              â”‚  â”‚
â”‚  â”‚  - MÃ©dicos, exames          - Mensagens formatadas             â”‚  â”‚
â”‚  â”‚  - Especialidades           - TransferÃªncia secretÃ¡ria         â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  ğŸ“ˆ TokenMonitor            ğŸ“… GoogleCalendarService            â”‚  â”‚
â”‚  â”‚  - Monitora tokens          - Disponibilidade real             â”‚  â”‚
â”‚  â”‚  - Modo econÃ´mico           - HorÃ¡rios livres                  â”‚  â”‚
â”‚  â”‚  - Alertas de uso           - ValidaÃ§Ã£o de datas               â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                          â”‚                          â”‚
           â–¼                          â–¼                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ’¾ DATABASE â”‚          â”‚ ğŸ’¨ CACHE    â”‚          â”‚ ğŸ”® GEMINI AIâ”‚
    â”‚   SQLite3   â”‚          â”‚ Django Mem  â”‚          â”‚  Google API â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ - Sessions  â”‚          â”‚ - Sessions  â”‚          â”‚ - AnÃ¡lise   â”‚
    â”‚ - Messages  â”‚          â”‚ - Clinic    â”‚          â”‚ - Resposta  â”‚
    â”‚ - Clinic    â”‚          â”‚   Data      â”‚          â”‚ - Entidades â”‚
    â”‚   Data      â”‚          â”‚ - Tokens    â”‚          â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ğŸ“… GOOGLE CALENDAR API    â”‚
                    â”‚  - Disponibilidade mÃ©dicos â”‚
                    â”‚  - HorÃ¡rios livres         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo de Dados Completo

### SequÃªncia Detalhada: Da Mensagem Ã  Resposta

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 1: RECEPÃ‡ÃƒO DA MENSAGEM                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“± Paciente (WhatsApp)
   â”‚
   â”‚ Envia: "OlÃ¡, gostaria de agendar uma consulta"
   â”‚
   â–¼
ğŸŒ WhatsApp Business API
   â”‚
   â”‚ POST https://seu-dominio.com/webhook/
   â”‚ {
   â”‚   "from": "5573988221003",
   â”‚   "text": "OlÃ¡, gostaria de agendar uma consulta",
   â”‚   "timestamp": "2024-10-09T14:30:00Z"
   â”‚ }
   â”‚
   â–¼
ğŸ“¨ Django: api_gateway/views.py
   â”‚
   â”‚ def whatsapp_webhook(request):
   â”‚     â”œâ”€ Valida verificaÃ§Ã£o (GET)
   â”‚     â”œâ”€ Processa mensagem (POST)
   â”‚     â””â”€ Chama process_message()
   â”‚
   â–¼


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 2: PROCESSAMENTO INICIAL                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“¨ views.process_message(phone, message)
   â”‚
   â”‚ 1. Extrai dados do webhook
   â”‚    â”œâ”€ phone_number: "5573988221003"
   â”‚    â”œâ”€ message_text: "OlÃ¡, gostaria de agendar..."
   â”‚    â””â”€ timestamp: "2024-10-09T14:30:00Z"
   â”‚
   â”‚ 2. Chama GeminiChatbotService
   â”‚
   â–¼
ğŸ¤– gemini_chatbot_service.process_message()
   â”‚
   â”‚ Log: ğŸ” Processando mensagem de 5573988221003
   â”‚
   â–¼


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 3: ORQUESTRAÃ‡ÃƒO (GeminiChatbotService)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– GeminiChatbotService.process_message()
   â”‚
   â”œâ”€ PASSO 1: Obter/Criar SessÃ£o
   â”‚  â”‚
   â”‚  â”œâ”€ session = _get_or_create_session(phone_number)
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Busca em cache: gemini_session_5573988221003
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Se nÃ£o existe:
   â”‚  â”‚  â”‚  â””â”€ Cria nova sessÃ£o:
   â”‚  â”‚  â”‚     {
   â”‚  â”‚  â”‚       'phone_number': '5573988221003',
   â”‚  â”‚  â”‚       'current_state': 'idle',
   â”‚  â”‚  â”‚       'patient_name': None,
   â”‚  â”‚  â”‚       'selected_doctor': None,
   â”‚  â”‚  â”‚       'preferred_date': None,
   â”‚  â”‚  â”‚       'preferred_time': None
   â”‚  â”‚  â”‚     }
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Salva em cache (15 min)
   â”‚  â”‚
   â”‚  â””â”€ Log: âœ… SessÃ£o obtida - Estado: idle
   â”‚
   â”œâ”€ PASSO 2: Obter Dados da ClÃ­nica (Otimizado)
   â”‚  â”‚
   â”‚  â”œâ”€ clinic_data = _get_clinic_data_optimized()
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Verifica cache: gemini_clinic_data
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Se cache vazio:
   â”‚  â”‚  â”‚  â””â”€ RAGService.get_all_clinic_data()
   â”‚  â”‚  â”‚     â”œâ”€ Consulta banco de dados
   â”‚  â”‚  â”‚     â”œâ”€ Retorna:
   â”‚  â”‚  â”‚     â”‚  {
   â”‚  â”‚  â”‚     â”‚    'clinica_info': {...},
   â”‚  â”‚  â”‚     â”‚    'medicos': [...],
   â”‚  â”‚  â”‚     â”‚    'especialidades': [...],
   â”‚  â”‚  â”‚     â”‚    'convenios': [...],
   â”‚  â”‚  â”‚     â”‚    'exames': [...]
   â”‚  â”‚  â”‚     â”‚  }
   â”‚  â”‚  â”‚     â””â”€ Salva em cache (15 min normal, dinÃ¢mico)
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Se cache existe: retorna do cache
   â”‚  â”‚
   â”‚  â””â”€ Log: ğŸ“‹ Dados da clÃ­nica obtidos (cache: sim/nÃ£o)
   â”‚
   â”œâ”€ PASSO 3: Obter HistÃ³rico da Conversa
   â”‚  â”‚
   â”‚  â”œâ”€ conversation_history = _get_conversation_history(phone_number, limit=10)
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ conversation_service.get_conversation_history()
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â”œâ”€ Consulta banco:
   â”‚  â”‚  â”‚  â”‚  ConversationMessage.objects.filter(
   â”‚  â”‚  â”‚  â”‚    session__phone_number=phone_number
   â”‚  â”‚  â”‚  â”‚  ).order_by('-timestamp')[:5]
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ Retorna Ãºltimas 10 mensagens
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Retorna: [
   â”‚  â”‚       {'content': '...', 'message_type': 'user', ...},
   â”‚  â”‚       {'content': '...', 'message_type': 'bot', ...}
   â”‚  â”‚     ]
   â”‚  â”‚
   â”‚  â””â”€ Log: ğŸ“œ HistÃ³rico obtido: 0 mensagens (primeira conversa)
   â”‚
   â”œâ”€ PASSO 4: Verificar se Ã© SolicitaÃ§Ã£o de HorÃ¡rios
   â”‚  â”‚
   â”‚  â”œâ”€ is_scheduling = _is_scheduling_request(message)
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Verifica palavras-chave:
   â”‚  â”‚  â”‚  - horÃ¡rio, agendar, marcar, consulta
   â”‚  â”‚  â”‚  - disponÃ­vel, quando, que horas
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Retorna: True (contÃ©m "agendar")
   â”‚  â”‚
   â”‚  â””â”€ Log: ğŸ” SolicitaÃ§Ã£o de agendamento detectada
   â”‚
   â”œâ”€ PASSO 5: AnÃ¡lise com Gemini AI
   â”‚  â”‚
   â”‚  â”œâ”€ analysis_result = _analyze_message_with_gemini(
   â”‚  â”‚      message, session, history, clinic_data
   â”‚  â”‚    )
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Construir prompt de anÃ¡lise:
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ prompt = """
   â”‚  â”‚  â”‚      VocÃª Ã© assistente da ClÃ­nica PneumoSono.
   â”‚  â”‚  â”‚      
   â”‚  â”‚  â”‚      MENSAGEM: "OlÃ¡, gostaria de agendar uma consulta"
   â”‚  â”‚  â”‚      ESTADO: idle
   â”‚  â”‚  â”‚      HISTÃ“RICO: (vazio)
   â”‚  â”‚  â”‚      
   â”‚  â”‚  â”‚      ANALISE:
   â”‚  â”‚  â”‚      - Qual a intenÃ§Ã£o?
   â”‚  â”‚  â”‚      - PrÃ³ximo estado?
   â”‚  â”‚  â”‚      - Entidades extraÃ­das?
   â”‚  â”‚  â”‚      
   â”‚  â”‚  â”‚      Responda em JSON.
   â”‚  â”‚  â”‚      """
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Enviar para Gemini:
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â”œâ”€ model.generate_content(
   â”‚  â”‚  â”‚  â”‚    prompt,
   â”‚  â”‚  â”‚  â”‚    generation_config={
   â”‚  â”‚  â”‚  â”‚      "temperature": 0.1,
   â”‚  â”‚  â”‚  â”‚      "max_output_tokens": 300
   â”‚  â”‚  â”‚  â”‚    }
   â”‚  â”‚  â”‚  â”‚  )
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ Resposta Gemini:
   â”‚  â”‚  â”‚      {
   â”‚  â”‚  â”‚        "intent": "agendar_consulta",
   â”‚  â”‚  â”‚        "next_state": "collecting_patient_info",
   â”‚  â”‚  â”‚        "entities": {},
   â”‚  â”‚  â”‚        "confidence": 0.95
   â”‚  â”‚  â”‚      }
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ token_monitor.log_token_usage("ANÃLISE", ...)
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ Log: ğŸ“Š TOKENS - ANÃLISE: 
   â”‚  â”‚  â”‚           Input=1,245, Output=156, Total=1,401
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Retorna anÃ¡lise parseada
   â”‚  â”‚
   â”‚  â””â”€ Log: ğŸ” IntenÃ§Ã£o: agendar_consulta (0.95)
   â”‚
   â”œâ”€ PASSO 6: Gerar Resposta com Gemini
   â”‚  â”‚
   â”‚  â”œâ”€ response_result = _generate_response_with_gemini(
   â”‚  â”‚      message, analysis_result, session, history, clinic_data
   â”‚  â”‚    )
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Construir prompt de resposta:
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ prompt = """
   â”‚  â”‚  â”‚      INTENÃ‡ÃƒO: agendar_consulta
   â”‚  â”‚  â”‚      PRÃ“XIMO ESTADO: collecting_patient_info
   â”‚  â”‚  â”‚      
   â”‚  â”‚  â”‚      Gere uma resposta cordial solicitando 
   â”‚  â”‚  â”‚      o nome completo do paciente.
   â”‚  â”‚  â”‚      """
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Enviar para Gemini:
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ Resposta: "OlÃ¡! ğŸ˜Š Fico feliz em ajudar 
   â”‚  â”‚  â”‚                 com seu agendamento. Para 
   â”‚  â”‚  â”‚                 comeÃ§ar, qual Ã© o seu nome 
   â”‚  â”‚  â”‚                 completo?"
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ token_monitor.log_token_usage("RESPOSTA", ...)
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ Log: ğŸ“Š TOKENS - RESPOSTA:
   â”‚  â”‚  â”‚           Input=2,134, Output=287, Total=2,421
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Retorna resposta formatada
   â”‚  â”‚
   â”‚  â””â”€ Log: ğŸ’¬ Resposta gerada (287 tokens)
   â”‚
   â”œâ”€ PASSO 7: Verificar ConfirmaÃ§Ã£o de Agendamento
   â”‚  â”‚
   â”‚  â”œâ”€ if analysis_result['intent'] == 'confirmar_agendamento':
   â”‚  â”‚    â””â”€ (Neste caso: nÃ£o, Ã© 'agendar_consulta')
   â”‚  â”‚
   â”‚  â””â”€ Pula validaÃ§Ã£o de handoff
   â”‚
   â”œâ”€ PASSO 8: Atualizar SessÃ£o
   â”‚  â”‚
   â”‚  â”œâ”€ _update_session(phone_number, session, 
   â”‚  â”‚                  analysis_result, response_result)
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Atualiza estado:
   â”‚  â”‚  â”‚  session['current_state'] = 'collecting_patient_info'
   â”‚  â”‚  â”‚  session['last_activity'] = now()
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Extrai entidades (neste caso: nenhuma)
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Salva em cache
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Sincroniza com banco:
   â”‚  â”‚     _sync_session_to_database(phone_number, session)
   â”‚  â”‚     â”‚
   â”‚  â”‚     â”œâ”€ ConversationSession.objects.update_or_create(
   â”‚  â”‚     â”‚    phone_number=phone_number,
   â”‚  â”‚     â”‚    defaults={...}
   â”‚  â”‚     â”‚  )
   â”‚  â”‚     â”‚
   â”‚  â”‚     â””â”€ Log: ğŸ’¾ SessÃ£o sincronizada - ID: 1
   â”‚  â”‚
   â”‚  â””â”€ Log: âœ… SessÃ£o atualizada - Estado: collecting_patient_info
   â”‚
   â”œâ”€ PASSO 9: Salvar Mensagens no Banco
   â”‚  â”‚
   â”‚  â”œâ”€ _save_conversation_messages(
   â”‚  â”‚      phone_number, message, response, analysis
   â”‚  â”‚    )
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ Salvar mensagem do usuÃ¡rio:
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â”œâ”€ ConversationMessage.objects.create(
   â”‚  â”‚  â”‚  â”‚    session=session,
   â”‚  â”‚  â”‚  â”‚    message_type='user',
   â”‚  â”‚  â”‚  â”‚    content="OlÃ¡, gostaria de agendar...",
   â”‚  â”‚  â”‚  â”‚    intent='agendar_consulta',
   â”‚  â”‚  â”‚  â”‚    confidence=0.95,
   â”‚  â”‚  â”‚  â”‚    entities={}
   â”‚  â”‚  â”‚  â”‚  )
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ Log: ğŸ’¾ Mensagem usuÃ¡rio salva - ID: 1
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Salvar resposta do bot:
   â”‚  â”‚     â”‚
   â”‚  â”‚     â”œâ”€ ConversationMessage.objects.create(
   â”‚  â”‚     â”‚    session=session,
   â”‚  â”‚     â”‚    message_type='bot',
   â”‚  â”‚     â”‚    content="OlÃ¡! ğŸ˜Š Fico feliz...",
   â”‚  â”‚     â”‚    intent='bot_response',
   â”‚  â”‚     â”‚    entities={}
   â”‚  â”‚     â”‚  )
   â”‚  â”‚     â”‚
   â”‚  â”‚     â””â”€ Log: ğŸ’¾ Mensagem bot salva - ID: 2
   â”‚  â”‚
   â”‚  â””â”€ Log: ğŸ’¾ Conversa persistida no banco
   â”‚
   â””â”€ PASSO 10: Retornar Resultado
      â”‚
      â””â”€ return {
           'response': "OlÃ¡! ğŸ˜Š Fico feliz em ajudar...",
           'intent': 'agendar_consulta',
           'confidence': 0.95,
           'state': 'collecting_patient_info',
           'agent': 'gemini'
         }


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 4: ENVIO DA RESPOSTA                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“¨ views.process_message()
   â”‚
   â”œâ”€ Recebe resultado do GeminiChatbotService
   â”‚
   â”œâ”€ whatsapp_service.send_message(
   â”‚    phone_number="5573988221003",
   â”‚    message="OlÃ¡! ğŸ˜Š Fico feliz em ajudar..."
   â”‚  )
   â”‚  â”‚
   â”‚  â”œâ”€ POST https://graph.facebook.com/v17.0/.../messages
   â”‚  â”‚  {
   â”‚  â”‚    "messaging_product": "whatsapp",
   â”‚  â”‚    "to": "5573988221003",
   â”‚  â”‚    "text": {
   â”‚  â”‚      "body": "OlÃ¡! ğŸ˜Š Fico feliz em ajudar..."
   â”‚  â”‚    }
   â”‚  â”‚  }
   â”‚  â”‚
   â”‚  â””â”€ Log: âœ… Mensagem enviada para WhatsApp
   â”‚
   â”œâ”€ return JsonResponse({'success': True})
   â”‚
   â””â”€ Log: ğŸ¯ Processamento completo - 2.3s
```

---

## ğŸ¬ Fluxo de Agendamento Visual (Exemplo Completo)

### Conversa Passo a Passo com Estados e Banco de Dados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MENSAGEM 1: SAUDAÃ‡ÃƒO E SOLICITAÃ‡ÃƒO                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ PACIENTE: "OlÃ¡, gostaria de agendar uma consulta"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROCESSAMENTO                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent: agendar_consulta             â”‚
â”‚ Confidence: 0.95                     â”‚
â”‚ Estado Atual: idle                   â”‚
â”‚ PrÃ³ximo Estado: collecting_patient_infoâ”‚
â”‚ Entidades: {}                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BANCO DE DADOS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConversationSession #1:              â”‚
â”‚ â”œâ”€ phone: 5573988221003              â”‚
â”‚ â”œâ”€ state: collecting_patient_info    â”‚
â”‚ â”œâ”€ patient_name: null                â”‚
â”‚ â”œâ”€ selected_doctor: null             â”‚
â”‚ â”œâ”€ preferred_date: null              â”‚
â”‚ â””â”€ preferred_time: null              â”‚
â”‚                                      â”‚
â”‚ ConversationMessage #1:              â”‚
â”‚ â”œâ”€ type: user                        â”‚
â”‚ â”œâ”€ content: "OlÃ¡, gostaria..."       â”‚
â”‚ â”œâ”€ intent: agendar_consulta          â”‚
â”‚ â””â”€ entities: {}                      â”‚
â”‚                                      â”‚
â”‚ ConversationMessage #2:              â”‚
â”‚ â”œâ”€ type: bot                         â”‚
â”‚ â””â”€ content: "OlÃ¡! ğŸ˜Š Fico feliz..."  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– BOT: "OlÃ¡! ğŸ˜Š Fico feliz em ajudar com seu agendamento.
        Para comeÃ§ar, qual Ã© o seu nome completo?"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MENSAGEM 2: FORNECIMENTO DO NOME                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ PACIENTE: "Meu nome Ã© JoÃ£o Silva Santos"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROCESSAMENTO                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent: fornecer_nome                â”‚
â”‚ Confidence: 0.98                     â”‚
â”‚ Estado Atual: collecting_patient_infoâ”‚
â”‚ PrÃ³ximo Estado: confirming_name      â”‚
â”‚ Entidades: {                         â”‚
â”‚   nome_paciente: "JoÃ£o Silva Santos" â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXTRAÃ‡ÃƒO DE ENTIDADES (Gemini)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Regex Patterns aplicados:           â”‚
â”‚ âœ“ "meu nome Ã© ([A-Z][a-z]+ ...)"    â”‚
â”‚                                      â”‚
â”‚ Gemini Analysis:                     â”‚
â”‚ {                                    â”‚
â”‚   "nome_paciente": "JoÃ£o Silva Santos"â”‚
â”‚ }                                    â”‚
â”‚                                      â”‚
â”‚ ValidaÃ§Ã£o:                           â”‚
â”‚ âœ“ Nome tem >= 2 palavras            â”‚
â”‚ âœ“ Formato vÃ¡lido                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BANCO DE DADOS (Atualizado)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConversationSession #1:              â”‚
â”‚ â”œâ”€ state: confirming_name            â”‚
â”‚ â”œâ”€ pending_name: "JoÃ£o Silva Santos" â”‚â† Aguardando confirmaÃ§Ã£o
â”‚ â”œâ”€ patient_name: null                â”‚
â”‚ â”œâ”€ name_confirmed: false             â”‚
â”‚ â””â”€ ...                               â”‚
â”‚                                      â”‚
â”‚ ConversationMessage #3:              â”‚
â”‚ â”œâ”€ type: user                        â”‚
â”‚ â”œâ”€ content: "Meu nome Ã© JoÃ£o..."     â”‚
â”‚ â”œâ”€ entities: {                       â”‚
â”‚ â”‚    nome_paciente: "JoÃ£o Silva..."  â”‚
â”‚ â”‚  }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– BOT: "Prazer em conhecÃª-lo! SÃ³ para confirmar, seu nome Ã© 
        JoÃ£o Silva Santos? (Sim/NÃ£o)"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MENSAGEM 3: CONFIRMAÃ‡ÃƒO DO NOME                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ PACIENTE: "Sim"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROCESSAMENTO                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent: confirmar                    â”‚
â”‚ Confidence: 1.0                      â”‚
â”‚ Estado Atual: confirming_name        â”‚
â”‚ PrÃ³ximo Estado: selecting_doctor     â”‚
â”‚ Entidades: {}                        â”‚
â”‚                                      â”‚
â”‚ LÃ³gica de ConfirmaÃ§Ã£o:               â”‚
â”‚ â”œâ”€ Palavras detectadas: ["sim"]     â”‚
â”‚ â”œâ”€ pending_name existe: âœ“            â”‚
â”‚ â””â”€ AÃ§Ã£o: Confirmar nome              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BANCO DE DADOS (Atualizado)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConversationSession #1:              â”‚
â”‚ â”œâ”€ state: selecting_doctor           â”‚
â”‚ â”œâ”€ patient_name: "JoÃ£o Silva Santos" â”‚â† CONFIRMADO!
â”‚ â”œâ”€ pending_name: null                â”‚â† Limpo
â”‚ â”œâ”€ name_confirmed: true              â”‚â† Flag ativada
â”‚ â””â”€ ...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– BOT: "Perfeito, JoÃ£o Silva Santos! ğŸ‘
        
        Agora, com qual mÃ©dico vocÃª gostaria de agendar?
        
        Nossos mÃ©dicos:
        ğŸ‘¨â€âš•ï¸ Dr. Gustavo - Medicina do Sono, Pneumologia
        ğŸ‘¨â€âš•ï¸ Dr. Gleyton Porto - Endocrinologia"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MENSAGEM 4: SELEÃ‡ÃƒO DO MÃ‰DICO                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ PACIENTE: "Dr. Gustavo"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROCESSAMENTO                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent: selecionar_medico            â”‚
â”‚ Confidence: 0.97                     â”‚
â”‚ Estado Atual: selecting_doctor       â”‚
â”‚ PrÃ³ximo Estado: choosing_schedule    â”‚
â”‚ Entidades: {                         â”‚
â”‚   medico: "Dr. Gustavo"              â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDAÃ‡ÃƒO DE MÃ‰DICO                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SmartSchedulingService:              â”‚
â”‚ â”œâ”€ _validate_doctor("Dr. Gustavo")   â”‚
â”‚ â”‚  â”‚                                 â”‚
â”‚ â”‚  â”œâ”€ Query: Medico.objects.filter( â”‚
â”‚ â”‚  â”‚   nome__icontains="gustavo"    â”‚
â”‚ â”‚  â”‚ )                               â”‚
â”‚ â”‚  â”‚                                 â”‚
â”‚ â”‚  â””â”€ Resultado: âœ“ MÃ©dico encontradoâ”‚
â”‚ â”‚     {                              â”‚
â”‚ â”‚       id: 1,                       â”‚
â”‚ â”‚       nome: "Dr. Gustavo",         â”‚
â”‚ â”‚       especialidades: ["Medicina   â”‚
â”‚ â”‚         do Sono", "Pneumologia"],  â”‚
â”‚ â”‚       preco_particular: 150.00     â”‚
â”‚ â”‚     }                              â”‚
â”‚ â”‚                                    â”‚
â”‚ â””â”€ Buscar horÃ¡rios disponÃ­veis:      â”‚
â”‚    GoogleCalendarService.get_doctor_ â”‚
â”‚      availability("Dr. Gustavo", 7)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONSULTA GOOGLE CALENDAR              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ API Call:                            â”‚
â”‚ calendar.events().list(              â”‚
â”‚   calendarId='primary',              â”‚
â”‚   timeMin='2024-10-09T00:00:00Z',    â”‚
â”‚   timeMax='2024-10-16T23:59:59Z',    â”‚
â”‚   q='Dr. Gustavo'                    â”‚
â”‚ )                                    â”‚
â”‚                                      â”‚
â”‚ Resultado:                           â”‚
â”‚ {                                    â”‚
â”‚   "days": [                          â”‚
â”‚     {                                â”‚
â”‚       "date": "14/10/2024",          â”‚
â”‚       "weekday": "Segunda-feira",    â”‚
â”‚       "available_times": [           â”‚
â”‚         "08:00", "09:00", "10:00",   â”‚
â”‚         "14:00", "15:00", "16:00"    â”‚
â”‚       ]                              â”‚
â”‚     },                               â”‚
â”‚     {                                â”‚
â”‚       "date": "16/10/2024",          â”‚
â”‚       "weekday": "Quarta-feira",     â”‚
â”‚       "available_times": [           â”‚
â”‚         "08:00", "09:00", "14:00"    â”‚
â”‚       ]                              â”‚
â”‚     }                                â”‚
â”‚   ]                                  â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BANCO DE DADOS (Atualizado)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConversationSession #1:              â”‚
â”‚ â”œâ”€ state: choosing_schedule          â”‚
â”‚ â”œâ”€ patient_name: "JoÃ£o Silva Santos" â”‚
â”‚ â”œâ”€ selected_doctor: "Dr. Gustavo"    â”‚â† ATUALIZADO!
â”‚ â””â”€ ...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– BOT: "Excelente escolha! ğŸ‘¨â€âš•ï¸
        
        Dr. Gustavo
        ğŸ©º Medicina do Sono, Pneumologia
        ğŸ’° Consulta particular: R$ 150,00
        
        ğŸ“… HorÃ¡rios disponÃ­veis:
        
        Segunda-feira (14/10/2024):
        âœ… 08:00, 09:00, 10:00, 14:00, 15:00, 16:00
        
        Quarta-feira (16/10/2024):
        âœ… 08:00, 09:00, 14:00
        
        Qual data e horÃ¡rio seria melhor para vocÃª?"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MENSAGEM 5: ESCOLHA DE DATA E HORÃRIO                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ PACIENTE: "Segunda-feira Ã s 14h"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROCESSAMENTO                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent: escolher_horario             â”‚
â”‚ Confidence: 0.96                     â”‚
â”‚ Estado Atual: choosing_schedule      â”‚
â”‚ PrÃ³ximo Estado: confirming           â”‚
â”‚ Entidades: {                         â”‚
â”‚   data: "segunda-feira",             â”‚
â”‚   horario: "14:00"                   â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NORMALIZAÃ‡ÃƒO DE DATA                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input: "segunda-feira"               â”‚
â”‚                                      â”‚
â”‚ _normalize_date_for_database():      â”‚
â”‚ â”œâ”€ Detecta: dia da semana            â”‚
â”‚ â”œâ”€ Hoje: 09/10/2024 (Quarta)        â”‚
â”‚ â”œâ”€ PrÃ³xima segunda: 14/10/2024       â”‚
â”‚ â””â”€ Retorna: date(2024, 10, 14)       â”‚
â”‚                                      â”‚
â”‚ Input: "14h"                         â”‚
â”‚                                      â”‚
â”‚ _parse_time():                       â”‚
â”‚ â”œâ”€ Detecta: "(\d{1,2})h"             â”‚
â”‚ â”œâ”€ Extrai: hora=14                   â”‚
â”‚ â””â”€ Retorna: "14:00"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BANCO DE DADOS (Atualizado)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConversationSession #1:              â”‚
â”‚ â”œâ”€ state: confirming                 â”‚
â”‚ â”œâ”€ patient_name: "JoÃ£o Silva Santos" â”‚
â”‚ â”œâ”€ selected_doctor: "Dr. Gustavo"    â”‚
â”‚ â”œâ”€ preferred_date: 2024-10-14        â”‚â† ATUALIZADO!
â”‚ â”œâ”€ preferred_time: 14:00:00          â”‚â† ATUALIZADO!
â”‚ â””â”€ ...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– BOT: "Perfeito! ğŸ“‹
        
        Vamos confirmar os dados do seu prÃ©-agendamento:
        
        ğŸ‘¤ Paciente: JoÃ£o Silva Santos
        ğŸ‘¨â€âš•ï¸ MÃ©dico: Dr. Gustavo
        ğŸ“… Data: Segunda-feira, 14/10/2024
        ğŸ• HorÃ¡rio: 14:00
        
        EstÃ¡ tudo correto? (Sim/NÃ£o)"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MENSAGEM 6: CONFIRMAÃ‡ÃƒO FINAL E HANDOFF                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ‘¤ PACIENTE: "Sim, estÃ¡ correto"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROCESSAMENTO                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent: confirmar_agendamento        â”‚â† GATILHO!
â”‚ Confidence: 0.99                     â”‚
â”‚ Estado Atual: confirming             â”‚
â”‚ PrÃ³ximo Estado: confirming           â”‚
â”‚ Entidades: {}                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDAÃ‡ÃƒO DE INFORMAÃ‡Ã•ES              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _validate_appointment_info():        â”‚
â”‚                                      â”‚
â”‚ Verificando campos obrigatÃ³rios:     â”‚
â”‚ âœ“ Nome: "JoÃ£o Silva Santos"         â”‚
â”‚ âœ“ MÃ©dico: "Dr. Gustavo"              â”‚
â”‚ âœ“ Data: 2024-10-14                   â”‚
â”‚ âœ“ HorÃ¡rio: 14:00                     â”‚
â”‚                                      â”‚
â”‚ Resultado:                           â”‚
â”‚ {                                    â”‚
â”‚   is_complete: true,                 â”‚
â”‚   missing_info: []                   â”‚
â”‚ }                                    â”‚
â”‚                                      â”‚
â”‚ âœ… TODAS INFORMAÃ‡Ã•ES PRESENTES!      â”‚
â”‚ Prosseguir com handoff...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GERAÃ‡ÃƒO DE HANDOFF                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ handoff_service.generate_appointment_â”‚
â”‚   handoff_link():                    â”‚
â”‚                                      â”‚
â”‚ 1. Coletar informaÃ§Ãµes:              â”‚
â”‚    â”œâ”€ patient: "JoÃ£o Silva Santos"   â”‚
â”‚    â”œâ”€ doctor: "Dr. Gustavo"          â”‚
â”‚    â”œâ”€ date: "14/10/2024"             â”‚
â”‚    â””â”€ time: "14:00"                  â”‚
â”‚                                      â”‚
â”‚ 2. Criar mensagem formatada:         â”‚
â”‚    base_message = """                â”‚
â”‚    OlÃ¡, gostaria de confirmar meu    â”‚
â”‚    prÃ©-agendamento:                  â”‚
â”‚                                      â”‚
â”‚    ğŸ‘¤ Paciente: JoÃ£o Silva Santos    â”‚
â”‚    ğŸ‘¨â€âš•ï¸ MÃ©dico: Dr. Gustavo          â”‚
â”‚    ğŸ“… Data: 14/10/2024               â”‚
â”‚    ğŸ• HorÃ¡rio: 14:00                 â”‚
â”‚    """                               â”‚
â”‚                                      â”‚
â”‚ 3. URL encode:                       â”‚
â”‚    encoded = urllib.parse.quote(     â”‚
â”‚      base_message                    â”‚
â”‚    )                                 â”‚
â”‚                                      â”‚
â”‚ 4. Gerar link WhatsApp:              â”‚
â”‚    link = f"https://wa.me/           â”‚
â”‚      5573988221003?text={encoded}"   â”‚
â”‚                                      â”‚
â”‚ 5. Resultado:                        â”‚
â”‚    "https://wa.me/5573988221003?     â”‚
â”‚     text=Ol%C3%A1%2C%20gostaria%..." â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BANCO DE DADOS (Final)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConversationSession #1:              â”‚
â”‚ â”œâ”€ state: confirming                 â”‚
â”‚ â”œâ”€ patient_name: "JoÃ£o Silva Santos" â”‚
â”‚ â”œâ”€ selected_doctor: "Dr. Gustavo"    â”‚
â”‚ â”œâ”€ preferred_date: 2024-10-14        â”‚
â”‚ â”œâ”€ preferred_time: 14:00:00          â”‚
â”‚ â”œâ”€ created_at: 2024-10-09 14:30      â”‚
â”‚ â”œâ”€ updated_at: 2024-10-09 14:35      â”‚
â”‚ â””â”€ last_activity: 2024-10-09 14:35   â”‚
â”‚                                      â”‚
â”‚ Total Mensagens: 12                  â”‚
â”‚ (6 do usuÃ¡rio + 6 do bot)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– BOT: "âœ… Perfeito! Vamos confirmar seu prÃ©-agendamento:

        ğŸ“‹ RESUMO:
        ğŸ‘¤ Paciente: JoÃ£o Silva Santos
        ğŸ‘¨â€âš•ï¸ MÃ©dico: Dr. Gustavo
        ğŸ“… Data: Segunda-feira, 14/10/2024
        ğŸ• HorÃ¡rio: 14:00
        
        ğŸ”„ Para CONFIRMAR definitivamente:
        ğŸ‘©â€ğŸ’¼ Nossa secretÃ¡ria validarÃ¡ a disponibilidade e 
        confirmarÃ¡ seu agendamento.
        
        ğŸ“ Clique no link abaixo para falar diretamente com 
        nossa equipe:
        https://wa.me/5573988221003?text=Ol%C3%A1%2C%20gostaria..."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RESULTADO FINAL: PACIENTE CLICA NO LINK                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“± Paciente clica no link de handoff

   â†“

ğŸŒ WhatsApp abre conversa com secretÃ¡ria

   â†“

ğŸ‘©â€ğŸ’¼ SecretÃ¡ria recebe mensagem prÃ©-formatada:

"OlÃ¡, gostaria de confirmar meu prÃ©-agendamento:

ğŸ‘¤ Paciente: JoÃ£o Silva Santos
ğŸ‘¨â€âš•ï¸ MÃ©dico: Dr. Gustavo
ğŸ“… Data: 14/10/2024
ğŸ• HorÃ¡rio: 14:00"

   â†“

âœ… SecretÃ¡ria valida disponibilidade no sistema

   â†“

âœ… SecretÃ¡ria confirma agendamento com paciente

   â†“

ğŸ“… Agendamento inserido no Google Calendar

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“Š PersistÃªncia e SincronizaÃ§Ã£o

### Diagrama de SincronizaÃ§Ã£o Cache + Banco de Dados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESTRATÃ‰GIA DE PERSISTÃŠNCIA DUAL                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ’¨ CACHE (Django)     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   ğŸ’¾ BANCO DE DADOS     â”‚
â”‚   django.core.cache     â”‚  Sync   â”‚   SQLite3               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚         â”‚                         â”‚
â”‚ Chave: gemini_session_  â”‚         â”‚ ConversationSession:    â”‚
â”‚        5573988221003    â”‚         â”‚ â”œâ”€ id: 1                â”‚
â”‚                         â”‚         â”‚ â”œâ”€ phone: 5573988221003 â”‚
â”‚ Valor: {                â”‚         â”‚ â”œâ”€ patient_name: "JoÃ£o" â”‚
â”‚   phone: "557398...",   â”‚         â”‚ â”œâ”€ selected_doctor: ... â”‚
â”‚   current_state: "...", â”‚         â”‚ â”œâ”€ preferred_date: ...  â”‚
â”‚   patient_name: "...",  â”‚         â”‚ â”œâ”€ preferred_time: ...  â”‚
â”‚   ...                   â”‚         â”‚ â””â”€ ...                  â”‚
â”‚ }                       â”‚         â”‚                         â”‚
â”‚                         â”‚         â”‚ ConversationMessage:    â”‚
â”‚ Timeout: 15-60 min      â”‚         â”‚ â”œâ”€ id: 1-12             â”‚
â”‚ (Baseado em uso tokens) â”‚         â”‚ â”œâ”€ session_id: 1        â”‚
â”‚                         â”‚         â”‚ â”œâ”€ message_type: ...    â”‚
â”‚ Chave: gemini_clinic_   â”‚         â”‚ â”œâ”€ content: ...         â”‚
â”‚        data             â”‚         â”‚ â””â”€ ...                  â”‚
â”‚                         â”‚         â”‚                         â”‚
â”‚ Valor: {                â”‚         â”‚ Persistente             â”‚
â”‚   clinica_info: {...},  â”‚         â”‚ HistÃ³rico completo      â”‚
â”‚   medicos: [...],       â”‚         â”‚ Auditoria               â”‚
â”‚   ...                   â”‚         â”‚                         â”‚
â”‚ }                       â”‚         â”‚                         â”‚
â”‚                         â”‚         â”‚                         â”‚
â”‚ Timeout: 15-60 min      â”‚         â”‚                         â”‚
â”‚ (Baseado em uso tokens) â”‚         â”‚                         â”‚
â”‚                         â”‚         â”‚                         â”‚
â”‚ Chave: gemini_tokens_   â”‚         â”‚                         â”‚
â”‚        2024-10-09       â”‚         â”‚                         â”‚
â”‚                         â”‚         â”‚                         â”‚
â”‚ Valor: 125678           â”‚         â”‚                         â”‚
â”‚ (Total tokens usado)    â”‚         â”‚                         â”‚
â”‚                         â”‚         â”‚                         â”‚
â”‚ Timeout: 24h            â”‚         â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â¬†ï¸                                    â¬†ï¸
       â”‚                                     â”‚
       â”‚                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚  LEITURA RÃPIDA â”‚              â”‚ PERSISTÃŠNCIA     â”‚
â”‚  - Sessions     â”‚              â”‚ - HistÃ³rico      â”‚
â”‚  - Clinic Data  â”‚              â”‚ - Auditoria      â”‚
â”‚  - Tokens       â”‚              â”‚ - Backup         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


FLUXO DE ATUALIZAÃ‡ÃƒO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£ Nova Mensagem Chega
   â†“
2ï¸âƒ£ Buscar SessÃ£o:
   â”œâ”€ Primeiro: Tenta cache â† RÃPIDO (ms)
   â””â”€ Se nÃ£o existe: Busca banco â†’ Cache â† LENTO (50ms)
   â†“
3ï¸âƒ£ Processar com Gemini
   â†“
4ï¸âƒ£ Atualizar SessÃ£o:
   â”œâ”€ Atualiza cache â† INSTANTÃ‚NEO
   â””â”€ Sincroniza banco â† ASSÃNCRONO
   â†“
5ï¸âƒ£ Salvar Mensagens:
   â””â”€ Grava banco diretamente â† PERSISTENTE

BENEFÃCIOS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Performance: Cache primeiro (< 1ms)
âœ… PersistÃªncia: Banco sempre sincronizado
âœ… RecuperaÃ§Ã£o: Se cache limpo, reconstrÃ³i do banco
âœ… Escalabilidade: Cache compartilhado (Redis futuro)
âœ… Auditoria: HistÃ³rico completo no banco
```

---

## ğŸ“ˆ Monitoramento e Logs

### Sistema de Logs Estruturados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXEMPLO DE LOGS EM PRODUÃ‡ÃƒO (Processamento de 1 Mensagem)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[2024-10-09 14:30:15] INFO ğŸ“± Webhook recebido de 5573988221003
[2024-10-09 14:30:15] DEBUG ğŸ” Mensagem: "OlÃ¡, gostaria de agendar uma consulta"
[2024-10-09 14:30:15] INFO ğŸ¤– Iniciando processamento com GeminiChatbotService

[2024-10-09 14:30:15] INFO âœ… SessÃ£o obtida - Estado: idle, Nome: None
[2024-10-09 14:30:15] DEBUG ğŸ“‹ Dados da clÃ­nica obtidos (cache: nÃ£o)
[2024-10-09 14:30:15] DEBUG ğŸ“œ HistÃ³rico obtido: 0 mensagens

[2024-10-09 14:30:16] INFO ğŸ” AnÃ¡lise de intenÃ§Ã£o iniciada
[2024-10-09 14:30:16] INFO ğŸ“Š TOKENS - ANÃLISE: Input=1,245, Output=156, Total=1,401
[2024-10-09 14:30:16] INFO ğŸ“Š SESSÃƒO 5573988221003: Total=1,401, Acumulado=1,401
[2024-10-09 14:30:16] INFO ğŸ“Š DIA: Total=125,678, Limite=1,500,000, Uso=8.4%
[2024-10-09 14:30:16] INFO ğŸ” IntenÃ§Ã£o detectada: agendar_consulta (0.95)

[2024-10-09 14:30:17] INFO ğŸ’¬ GeraÃ§Ã£o de resposta iniciada
[2024-10-09 14:30:18] INFO ğŸ“Š TOKENS - RESPOSTA: Input=2,134, Output=287, Total=2,421
[2024-10-09 14:30:18] INFO ğŸ“Š SESSÃƒO 5573988221003: Total=2,421, Acumulado=3,822
[2024-10-09 14:30:18] INFO ğŸ“Š DIA: Total=128,099, Limite=1,500,000, Uso=8.5%

[2024-10-09 14:30:18] INFO âœ… SessÃ£o atualizada - Estado: collecting_patient_info
[2024-10-09 14:30:18] INFO ğŸ’¾ SessÃ£o sincronizada com banco - ID: 1
[2024-10-09 14:30:18] INFO ğŸ’¾ Mensagem usuÃ¡rio salva - ID: 1
[2024-10-09 14:30:18] INFO ğŸ’¾ Mensagem bot salva - ID: 2

[2024-10-09 14:30:19] INFO âœ… Mensagem enviada para WhatsApp
[2024-10-09 14:30:19] INFO ğŸ¯ Processamento completo em 3.2s

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOGS DE MONITORAMENTO DE TOKENS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[2024-10-09 08:00:00] INFO ğŸ“Š Tokens hoje: 0 / 1,500,000 (0.0%)
[2024-10-09 12:30:45] INFO ğŸ“Š Tokens hoje: 654,321 / 1,500,000 (43.6%)
[2024-10-09 18:45:12] WARNING âš ï¸ AVISO: Uso de tokens em 82.3% do limite diÃ¡rio
[2024-10-09 21:30:00] ERROR âš ï¸ ALERTA: Uso de tokens em 91.5% do limite diÃ¡rio
[2024-10-09 23:15:30] CRITICAL ğŸš¨ CRÃTICO: Uso de tokens em 96.1%!
[2024-10-09 23:15:30] WARNING ğŸ”„ Ativando modo econÃ´mico
[2024-10-09 23:15:30] INFO âœ… Modo econÃ´mico ativado - tokens preservados

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOGS DE ERRO (Exemplos):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[2024-10-09 14:30:20] ERROR âŒ Gemini API error: Rate limit exceeded
[2024-10-09 14:30:20] INFO ğŸ”„ Tentando novamente em 5s... (tentativa 1/3)

[2024-10-09 14:30:25] ERROR âŒ Erro ao consultar Google Calendar: 503
[2024-10-09 14:30:25] WARNING âš ï¸ Retornando horÃ¡rios do cache

[2024-10-09 14:30:30] ERROR âŒ Banco de dados nÃ£o acessÃ­vel
[2024-10-09 14:30:30] INFO ğŸ’¾ SessÃ£o mantida apenas em cache

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ”§ ConfiguraÃ§Ã£o e Deploy

### Arquivo .env (Template)

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# IMPORTANTE: Este arquivo contÃ©m informaÃ§Ãµes sensÃ­veis
# - NÃƒO commitar no git
# - Usar valores diferentes em dev/produÃ§Ã£o
# - Rotacionar chaves periodicamente
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GEMINI AI (Google)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GEMINI_API_KEY=AIzaSy...  # Obter em https://makersuite.google.com/app/apikey
GEMINI_MODEL=gemini-2.0-flash
GEMINI_ENABLED=True
GEMINI_TOKEN_MONITORING=True
GEMINI_DAILY_TOKEN_LIMIT=1500000

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# WHATSAPP BUSINESS API (Meta)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WHATSAPP_ACCESS_TOKEN=EAAJZBp...  # Token de acesso do app
WHATSAPP_PHONE_NUMBER_ID=123456789  # ID do nÃºmero de telefone
WHATSAPP_VERIFY_TOKEN=meu_token_secreto_123  # Token personalizado
WHATSAPP_API_URL=https://graph.facebook.com/v17.0

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GOOGLE CALENDAR API
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GOOGLE_CALENDAR_ENABLED=True
GOOGLE_SERVICE_ACCOUNT_FILE=service-account-key.json
CLINIC_CALENDAR_ID=primary

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CLÃNICA (Dados de NegÃ³cio)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CLINIC_NAME=ClÃ­nica PneumoSono
CLINIC_DOMAIN=https://clinica.exemplo.com
CLINIC_WHATSAPP_NUMBER=5573988221003  # NÃºmero da secretÃ¡ria

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DJANGO (ConfiguraÃ§Ãµes Gerais)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEBUG=False  # NUNCA True em produÃ§Ã£o!
SECRET_KEY=django-insecure-...  # Gerar com: python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
ALLOWED_HOSTS=localhost,127.0.0.1,seu-dominio.com

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# BANCO DE DADOS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATABASE_URL=sqlite:///db.sqlite3  # Prod: postgresql://user:pass@host:port/db

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CACHE (Opcional - usar Redis em produÃ§Ã£o)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDIS_URL=redis://localhost:6379/0  # Se usar Redis
```

### Processo de Deploy Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEPLOY PASSO A PASSO                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ETAPA 1: PREPARAÃ‡ÃƒO DO AMBIENTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$ git clone https://github.com/seu-usuario/chatbot_ClinicaMedica.git
$ cd chatbot_ClinicaMedica

$ python -m venv venv
$ source venv/bin/activate  # Linux/Mac
$ venv\Scripts\activate     # Windows

$ pip install -r requirements.txt

DependÃªncias instaladas:
âœ“ Django==5.0
âœ“ djangorestframework==3.14.0
âœ“ google-generativeai==0.3.0
âœ“ google-auth==2.25.0
âœ“ google-api-python-client==2.110.0
âœ“ requests==2.31.0


ETAPA 2: CONFIGURAÃ‡ÃƒO DE VARIÃVEIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$ cp .env.example .env
$ nano .env  # ou seu editor favorito

Configurar:
âœ“ GEMINI_API_KEY (obrigatÃ³rio)
âœ“ WHATSAPP_ACCESS_TOKEN (obrigatÃ³rio)
âœ“ WHATSAPP_PHONE_NUMBER_ID (obrigatÃ³rio)
âœ“ WHATSAPP_VERIFY_TOKEN (criar personalizado)
âœ“ GOOGLE_SERVICE_ACCOUNT_FILE (se usar Calendar)
âœ“ SECRET_KEY (gerar novo)


ETAPA 3: SETUP DO BANCO DE DADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$ python manage.py migrate

OperaÃ§Ãµes:
  âœ“ Applying contenttypes.0001_initial... OK
  âœ“ Applying auth.0001_initial... OK
  âœ“ Applying admin.0001_initial... OK
  âœ“ Applying rag_agent.0001_initial... OK
  âœ“ Applying rag_agent.0002_clinicainfo_whatsapp... OK
  âœ“ Applying rag_agent.0003_medico_crm... OK
  âœ“ Applying api_gateway.0001_initial... OK
  âœ“ Applying api_gateway.0002_alter_session_state... OK
  âœ“ Applying api_gateway.0003_session_name_confirmed... OK

$ python manage.py createsuperuser

Username: admin
Email: admin@clinica.com
Password: ******
Superuser created successfully.

$ python scripts/criar_dados_pneumosono.py

Dados criados:
âœ“ ClÃ­nica PneumoSono
âœ“ 2 MÃ©dicos (Dr. Gustavo, Dr. Gleyton Porto)
âœ“ 4 Especialidades
âœ“ 3 ConvÃªnios
âœ“ 2 Exames


ETAPA 4: CONFIGURAÃ‡ÃƒO DO GOOGLE CALENDAR (Opcional)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$ python scripts/setup_calendar_dev.py

Configurando Google Calendar:
âœ“ Service account autenticada
âœ“ Calendar API ativada
âœ“ PermissÃµes configuradas
âœ“ Teste de conexÃ£o: OK


ETAPA 5: TESTES DE INTEGRAÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$ python manage.py runserver

Development server running at: http://127.0.0.1:8000/

Testando endpoints:
âœ“ GET /test-gemini-connection/
  Response: {"status": "success", "model": "gemini-2.0-flash"}

âœ“ POST /test-chatbot-service/
  Request: {"phone_number": "5511999999999", "message": "OlÃ¡"}
  Response: {"response": "OlÃ¡! Como posso ajudar?", "intent": "saudacao"}

âœ“ GET /admin/
  Admin interface: OK


ETAPA 6: CONFIGURAÃ‡ÃƒO DO WEBHOOK (WhatsApp)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Meta Developer Console:
1. Acessar: https://developers.facebook.com/apps
2. Configurar Webhook:
   URL: https://seu-dominio.com/webhook/
   Verify Token: [seu WHATSAPP_VERIFY_TOKEN]
3. Subscrever eventos:
   âœ“ messages
   âœ“ message_status

Teste:
$ curl -X POST https://seu-dominio.com/webhook/ \
  -H "Content-Type: application/json" \
  -d '{"entry":[{"changes":[{"value":{"messages":[{"from":"5511999999999","text":{"body":"Teste"}}]}}]}]}'

Response: {"status": "ok"}


ETAPA 7: DEPLOY EM PRODUÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OpÃ§Ã£o A: Heroku
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$ heroku create chatbot-clinica
$ git push heroku main
$ heroku config:set GEMINI_API_KEY=...
$ heroku config:set WHATSAPP_ACCESS_TOKEN=...
$ heroku run python manage.py migrate
$ heroku run python scripts/criar_dados_pneumosono.py

OpÃ§Ã£o B: Railway
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$ railway login
$ railway init
$ railway up
# Configurar variÃ¡veis no dashboard

OpÃ§Ã£o C: VPS (Ubuntu)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$ sudo apt update
$ sudo apt install python3-pip python3-venv nginx
$ # ... configurar gunicorn, nginx, etc


ETAPA 8: MONITORAMENTO PÃ“S-DEPLOY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Verificar logs:
$ tail -f logs/django.log
$ tail -f logs/gemini.log

Monitorar tokens:
$ curl https://seu-dominio.com/token-usage-stats/

Testar webhook:
$ curl https://seu-dominio.com/webhook/?hub.mode=subscribe&hub.verify_token=...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… DEPLOY COMPLETO!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ¯ MÃ©tricas e Performance

### Dashboard de MÃ©tricas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DASHBOARD DE PERFORMANCE                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TEMPO DE RESPOSTA (MÃ©dias em ms)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OperaÃ§Ã£o                       â”‚ MÃ­nimo   â”‚ MÃ©dio    â”‚ MÃ¡ximo       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RecepÃ§Ã£o Webhook               â”‚   5 ms   â”‚  12 ms   â”‚   45 ms      â”‚
â”‚ Busca SessÃ£o (cache hit)       â”‚   1 ms   â”‚   3 ms   â”‚   10 ms      â”‚
â”‚ Busca SessÃ£o (cache miss)      â”‚  30 ms   â”‚  50 ms   â”‚  120 ms      â”‚
â”‚ AnÃ¡lise IntenÃ§Ã£o (Gemini)      â”‚ 200 ms   â”‚ 450 ms   â”‚  800 ms      â”‚
â”‚ GeraÃ§Ã£o Resposta (Gemini)      â”‚ 350 ms   â”‚ 750 ms   â”‚ 1500 ms      â”‚
â”‚ Consulta Google Calendar        â”‚ 400 ms   â”‚ 950 ms   â”‚ 2200 ms      â”‚
â”‚ Salvar Banco de Dados           â”‚  10 ms   â”‚  25 ms   â”‚   80 ms      â”‚
â”‚ Envio WhatsApp API              â”‚  80 ms   â”‚ 150 ms   â”‚  300 ms      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL (por mensagem)            â”‚ 1.2s     â”‚ 2.4s     â”‚ 5.0s         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


USO DE TOKENS (Ãšltimas 24h)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Tokens Usados:     654,321  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  43.6%
Limite DiÃ¡rio:   1,500,000
Tokens Restantes:  845,679

Por OperaÃ§Ã£o:
â”œâ”€ AnÃ¡lises (300 tokens/msg):     195,000  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  29.8%
â”œâ”€ Respostas (600 tokens/msg):    390,000  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  59.6%
â””â”€ Cache hits (economizados):      69,321  â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10.6%

Modo EconÃ´mico: âŒ Desativado (uso < 80%)


SESSÃ•ES E MENSAGENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SessÃµes Ativas (Ãºltimas 24h)   â”‚ 127                              â”‚
â”‚ Mensagens Processadas           â”‚ 1,543                            â”‚
â”‚ Agendamentos Iniciados          â”‚ 89                               â”‚
â”‚ Agendamentos Completos (Handoff)â”‚ 52                               â”‚
â”‚ Taxa de ConversÃ£o               â”‚ 58.4%                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


INTENÃ‡Ã•ES MAIS COMUNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IntenÃ§Ã£o               â”‚ Qtd      â”‚ GrÃ¡fico                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ agendar_consulta       â”‚  412     â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  53.3% â”‚
â”‚ buscar_info            â”‚  215     â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  27.8% â”‚
â”‚ buscar_medico          â”‚   98     â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  12.7% â”‚
â”‚ buscar_horarios        â”‚   47     â”‚ â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   6.1% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


SAÃšDE DO SISTEMA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ©trica                â”‚ Status   â”‚ Valor                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Uptime                 â”‚ âœ… OK    â”‚ 99.97% (Ãºltima semana)        â”‚
â”‚ Erros (Ãºltima hora)    â”‚ âœ… OK    â”‚ 2 (0.13%)                     â”‚
â”‚ LatÃªncia MÃ©dia         â”‚ âœ… OK    â”‚ 2.4s (< 3s)                   â”‚
â”‚ Uso CPU                â”‚ âœ… OK    â”‚ 34% (< 70%)                   â”‚
â”‚ Uso MemÃ³ria            â”‚ âš ï¸ WARN  â”‚ 78% (< 90%)                   â”‚
â”‚ ConexÃµes BD            â”‚ âœ… OK    â”‚ 12/100                        â”‚
â”‚ Cache Hit Rate         â”‚ âœ… OK    â”‚ 87%                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ğŸ“… Ãšltima AtualizaÃ§Ã£o:** Outubro 2024  
**ğŸ“ VersÃ£o:** 2.0 (Completa e Visual)  
**ğŸ‘¨â€ğŸ’» Desenvolvido com:** Django + Gemini AI + Google Calendar + WhatsApp Business API
