# üìÖ Setup Google Calendar - Desenvolvimento com Email Pessoal

Guia passo a passo para configurar o Google Calendar usando seu email pessoal `gzerbone@gmail.com` para testes de desenvolvimento.

## üéØ **Objetivo**

Configurar um calend√°rio de teste usando sua conta pessoal do Google para validar a integra√ß√£o antes de implementar na cl√≠nica real.

---

## üìã **PASSO 1: Criar Calend√°rio de Teste**

### **1.1 Acessar Google Calendar**
1. Abra [Google Calendar](https://calendar.google.com)
2. Fa√ßa login com `gzerbone@gmail.com`

### **1.2 Criar Novo Calend√°rio**
1. No lado esquerdo, clique no **"+"** ao lado de "Outros calend√°rios"
2. Selecione **"Criar novo calend√°rio"**
3. Preencha:
   ```
   Nome: Agenda Cl√≠nica Teste
   Descri√ß√£o: Calend√°rio para testes do chatbot da cl√≠nica
   Fuso hor√°rio: (UTC-03:00) Bras√≠lia
   ```
4. Clique em **"Criar calend√°rio"**

### **1.3 Encontrar o Calendar ID**
1. Ap√≥s criar, v√° em **"Configura√ß√µes e compartilhamento"** do calend√°rio
2. Role at√© **"Integrar calend√°rio"**
3. Copie o **"ID do calend√°rio"**
   ```
   Exemplo: c_1234567890abcdef@group.calendar.google.com
   ```
4. **ANOTE ESTE ID** - voc√™ precisar√° dele no `.env`

---

## üìã **PASSO 2: Configurar Google Cloud Console**

### **2.1 Criar Projeto**
1. Acesse [Google Cloud Console](https://console.cloud.google.com)
2. Fa√ßa login com `gzerbone@gmail.com`
3. Clique em **"Selecionar projeto"** ‚Üí **"Novo projeto"**
4. Nome: `chatbot-clinica-teste`
5. Clique em **"Criar"**

### **2.2 Habilitar Calendar API**
1. No menu lateral: **"APIs e servi√ßos"** ‚Üí **"Biblioteca"**
2. Busque: `Google Calendar API`
3. Clique na API e depois em **"Ativar"**

### **2.3 Criar Conta de Servi√ßo**
1. V√° para **"APIs e servi√ßos"** ‚Üí **"Credenciais"**
2. Clique **"+ Criar credenciais"** ‚Üí **"Conta de servi√ßo"**
3. Preencha:
   ```
   Nome: chatbot-calendar-service
   ID: chatbot-calendar-service
   Descri√ß√£o: Servi√ßo para consultar calend√°rio da cl√≠nica
   ```
4. Clique **"Criar e continuar"**
5. **Fun√ß√£o:** Selecione `Visualizador` ou pule esta etapa
6. Clique **"Conclu√≠do"**

### **2.4 Gerar Chave JSON**
1. Na lista de contas de servi√ßo, clique na conta criada
2. V√° para aba **"Chaves"**
3. Clique **"Adicionar chave"** ‚Üí **"Criar nova chave"**
4. Selecione **"JSON"**
5. **Baixe o arquivo** (ser√° algo como `chatbot-clinica-teste-abc123.json`)
6. **Renomeie para:** `service-account-key.json`
7. **Mova para a pasta do projeto:** `C:\Users\gabri\OneDrive\√Årea de Trabalho\ALL\Faculdade\TCC\chatbot_ClinicaMedica\`

---

## üìã **PASSO 3: Compartilhar Calend√°rio com Conta de Servi√ßo**

### **3.1 Obter Email da Conta de Servi√ßo**
1. Abra o arquivo `service-account-key.json` baixado
2. Procure o campo `"client_email"`
3. **Copie o email** (ser√° algo como: `chatbot-calendar-service@chatbot-clinica-teste.iam.gserviceaccount.com`)

### **3.2 Compartilhar Calend√°rio**
1. No Google Calendar, v√° no calend√°rio **"Agenda Cl√≠nica Teste"**
2. Clique nos **tr√™s pontos** ‚Üí **"Configura√ß√µes e compartilhamento"**
3. Em **"Compartilhar com pessoas espec√≠ficas"**, clique **"+ Adicionar pessoas"**
4. **Cole o email da conta de servi√ßo**
5. **Permiss√£o:** Selecione **"Ver todos os detalhes do evento"**
6. Clique **"Enviar"**

---

## üìã **PASSO 4: Configurar o Projeto Django**

### **4.1 Atualizar arquivo `.env`**
```env
# Configura√ß√µes do Google Calendar API
GOOGLE_CALENDAR_ENABLED=True
GOOGLE_SERVICE_ACCOUNT_FILE=service-account-key.json
CLINIC_DOMAIN=gmail.com
CLINIC_CALENDAR_ID=c_1234567890abcdef@group.calendar.google.com
```

**‚ö†Ô∏è IMPORTANTE:** Substitua `c_1234567890abcdef@group.calendar.google.com` pelo ID real do seu calend√°rio!

### **4.2 Instalar Depend√™ncias**
```bash
# Ativar ambiente virtual
venv\Scripts\activate

# Instalar depend√™ncias do Google Calendar
pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
```

---

## üìã **PASSO 5: Criar Eventos de Teste**

### **5.1 Adicionar Eventos no Google Calendar**

V√° no seu calend√°rio **"Agenda Cl√≠nica Teste"** e crie alguns eventos de exemplo:

#### **Segunda-feira (16/09/2025):**
```
09:00 - 09:30  ‚îÇ Dr. Jo√£o Carvalho - Consulta
14:00 - 14:30  ‚îÇ Dr. Jo√£o Carvalho - Retorno
15:30 - 16:00  ‚îÇ Dra. Maria Santos - Consulta
```

#### **Ter√ßa-feira (17/09/2025):**
```
08:30 - 09:00  ‚îÇ Dra. Maria Santos - Consulta
10:00 - 10:30  ‚îÇ Dr. Jo√£o Carvalho - Consulta
16:00 - 17:00  ‚îÇ Dra. Maria Santos - Procedimento
```

### **5.2 Formato Obrigat√≥rio dos Eventos**
```
‚úÖ CORRETO:
T√≠tulo: Dr. Jo√£o Carvalho - Consulta
T√≠tulo: Dra. Maria Santos - Procedimento
T√≠tulo: Dr. Jo√£o - Retorno

‚ùå INCORRETO:
T√≠tulo: Jo√£o - Consulta        (sem "Dr.")
T√≠tulo: Consulta Dr. Jo√£o      (ordem errada)
T√≠tulo: Paciente Maria Silva   (nome do paciente)
```

---

## üìã **PASSO 6: Testar a Integra√ß√£o**

### **6.1 Testar Conex√£o**
```bash
# No terminal do projeto
python test_calendar.py
```

**Sa√≠da esperada:**
```
üß™ Testando Google Calendar Service...
Habilitado: True

üìÖ Testando disponibilidade do Dr. Jo√£o...
Google Calendar conectado. Acesso ao calend√°rio confirmado.
Encontrados 2 eventos para Dr. Jo√£o Carvalho no calend√°rio da cl√≠nica
M√©dico: Dr. Jo√£o Carvalho
Per√≠odo: 16/09/2025 a 20/09/2025
```

### **6.2 Testar via API**
```bash
# Testar conex√£o
curl http://localhost:8000/api/test/calendar/

# Consultar disponibilidade
curl "http://localhost:8000/api/test/availability/Dr.%20Jo√£o%20Carvalho/?days=3"
```

### **6.3 Testar via Chatbot**
Envie mensagem no WhatsApp (se configurado):
```
üë§: "Quero agendar com Dr. Jo√£o"
ü§ñ: [Mostrar√° hor√°rios reais baseados no seu calend√°rio]
```

---

## üîß **CONFIGURA√á√ÉO COMPLETA DO .env**

Aqui est√° como seu arquivo `.env` deve ficar:

```env
# Configura√ß√µes do Django
DEBUG=True
SECRET_KEY=django-insecure-le135!_9$^gz#fscc)$l_*)#476!r^uxn($+^!^hebdhp=^j7w
ALLOWED_HOSTS=localhost,127.0.0.1,sua-url-do-ngrok.ngrok-free.app

# Configura√ß√µes do Gemini AI
GEMINI_API_KEY=sua_gemini_api_key_aqui
GEMINI_ENABLED=True
GEMINI_MODEL=gemini-1.5-flash
GEMINI_TEMPERATURE=0.7
GEMINI_MAX_TOKENS=1024

# Configura√ß√µes do WhatsApp Business API
WHATSAPP_ACCESS_TOKEN=seu_whatsapp_access_token_aqui
WHATSAPP_VERIFY_TOKEN=meu_verify_token_123
WHATSAPP_PHONE_NUMBER_ID=seu_phone_number_id_aqui
WHATSAPP_API_URL=https://graph.facebook.com/v18.0

# Configura√ß√µes do Google Calendar API
GOOGLE_CALENDAR_ENABLED=True
GOOGLE_SERVICE_ACCOUNT_FILE=service-account-key.json
CLINIC_DOMAIN=gmail.com
CLINIC_CALENDAR_ID=SEU_CALENDAR_ID_AQUI
```

**‚ö†Ô∏è Substitua `SEU_CALENDAR_ID_AQUI` pelo ID real do calend√°rio que voc√™ criou!**

---

## üîç **Como Encontrar o Calendar ID**

### **M√©todo 1: Via Interface do Google Calendar**
1. V√° no seu calend√°rio **"Agenda Cl√≠nica Teste"**
2. Clique nos **tr√™s pontos** ‚Üí **"Configura√ß√µes e compartilhamento"**
3. Role at√© **"Integrar calend√°rio"**
4. Copie o **"ID do calend√°rio"**

### **M√©todo 2: Via URL**
1. Clique no calend√°rio para selecion√°-lo
2. Observe a URL do navegador
3. O ID estar√° na URL ap√≥s `/calendar/`

### **Exemplo de Calendar ID:**
```
c_1a2b3c4d5e6f7g8h9i0j@group.calendar.google.com
```

---

## üì± **PASSO 7: Testar Fluxo Completo**

### **7.1 Criar Eventos de Teste**
No Google Calendar, crie:
```
Hoje + 1 dia:
09:00 - Dr. Jo√£o Carvalho - Consulta
14:30 - Dra. Maria Santos - Consulta

Hoje + 2 dias:  
10:00 - Dr. Jo√£o Carvalho - Retorno
15:00 - Dra. Maria Santos - Procedimento
```

### **7.2 Testar Chatbot**
```bash
# Executar servidor
python manage.py runserver

# Em outro terminal, testar
curl -X POST http://localhost:8000/api/test/intent/ \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Quero agendar com Dr. Jo√£o",
    "phone_number": "test_user",
    "use_context": true
  }'
```

### **7.3 Verificar Logs**
No terminal do Django, voc√™ deve ver:
```
INFO: Google Calendar conectado. Acesso ao calend√°rio confirmado.
INFO: Encontrados X eventos para Dr. Jo√£o Carvalho no calend√°rio da cl√≠nica
```

---

## üö® **Troubleshooting**

### **Erro: "Calendar not found"**
- ‚úÖ Verifique se o Calendar ID est√° correto no `.env`
- ‚úÖ Confirme se o calend√°rio foi criado
- ‚úÖ Teste copiar o ID novamente

### **Erro: "Permission denied"**
- ‚úÖ Verifique se compartilhou o calend√°rio com a conta de servi√ßo
- ‚úÖ Confirme se a permiss√£o √© "Ver todos os detalhes"
- ‚úÖ Aguarde alguns minutos para a permiss√£o propagar

### **Erro: "Service account not found"**
- ‚úÖ Verifique se o arquivo `service-account-key.json` est√° na pasta correta
- ‚úÖ Confirme se o caminho no `.env` est√° correto
- ‚úÖ Teste recriar a chave se necess√°rio

### **Eventos n√£o s√£o encontrados:**
- ‚úÖ Verifique se os eventos seguem o padr√£o "Dr. Nome - Tipo"
- ‚úÖ Confirme se os eventos est√£o no calend√°rio correto
- ‚úÖ Teste com nomes exatos dos m√©dicos do banco de dados

---

## üìä **Exemplo de Configura√ß√£o Final**

### **Seu arquivo `.env` ficar√° assim:**
```env
# ... outras configura√ß√µes ...

# Google Calendar (SEU SETUP DE TESTE)
GOOGLE_CALENDAR_ENABLED=True
GOOGLE_SERVICE_ACCOUNT_FILE=service-account-key.json
CLINIC_DOMAIN=gmail.com
CLINIC_CALENDAR_ID=c_abcd1234efgh5678@group.calendar.google.com
```

### **Estrutura de arquivos:**
```
chatbot_ClinicaMedica/
‚îú‚îÄ‚îÄ .env                          # Suas configura√ß√µes
‚îú‚îÄ‚îÄ service-account-key.json      # Chave baixada do Google Cloud
‚îú‚îÄ‚îÄ manage.py
‚îî‚îÄ‚îÄ ...
```

### **Eventos de teste no seu calend√°rio:**
```
üìÖ Agenda Cl√≠nica Teste (gzerbone@gmail.com)

Segunda (16/09):
üïê 09:00 - Dr. Jo√£o Carvalho - Consulta
üïê 14:00 - Dr. Jo√£o Carvalho - Retorno  
üïê 15:30 - Dra. Maria Santos - Consulta

Ter√ßa (17/09):
üïê 08:30 - Dra. Maria Santos - Consulta
üïê 10:00 - Dr. Jo√£o Carvalho - Consulta
üïê 16:00 - Dra. Maria Santos - Procedimento
```

---

## üß™ **Valida√ß√£o Final**

### **Teste 1: Conex√£o**
```bash
curl http://localhost:8000/api/test/calendar/
```

**Resposta esperada:**
```json
{
  "google_calendar_enabled": true,
  "connection_status": "connected", 
  "message": "Google Calendar funcionando"
}
```

### **Teste 2: Disponibilidade**
```bash
curl "http://localhost:8000/api/test/availability/Dr.%20Jo√£o%20Carvalho/?days=3"
```

**Resposta esperada:**
```json
{
  "doctor": "Dr. Jo√£o Carvalho",
  "availability": {
    "doctor_name": "Dr. Jo√£o Carvalho",
    "days": [
      {
        "date": "16/09/2025",
        "weekday": "Segunda",
        "available_times": ["08:00", "08:30", "09:30", "10:00", ...],
        "occupied_times": ["09:00", "14:00"]
      }
    ]
  }
}
```

### **Teste 3: Chatbot Integrado**
```bash
curl -X POST http://localhost:8000/api/test/intent/ \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Quero agendar com Dr. Jo√£o amanh√£",
    "phone_number": "test_user",
    "use_context": true
  }'
```

---

## üîÑ **Fluxo de Desenvolvimento**

### **Ciclo de Teste:**
```
1. üìù Criar evento no Google Calendar
   "Dr. Jo√£o Carvalho - Consulta" (14:00-14:30)

2. üß™ Testar API
   curl .../availability/Dr.%20Jo√£o/

3. ‚úÖ Verificar resposta
   Hor√°rio 14:00 deve aparecer como ocupado

4. ü§ñ Testar chatbot
   "Quero Dr. Jo√£o amanh√£" ‚Üí Deve mostrar hor√°rios livres

5. üîÑ Repetir com diferentes cen√°rios
```

### **Cen√°rios de Teste Sugeridos:**

#### **Cen√°rio 1: M√©dico com poucos agendamentos**
```
Eventos: 1 consulta de manh√£
Resultado: Muitos hor√°rios livres
```

#### **Cen√°rio 2: M√©dico muito ocupado**
```
Eventos: 6-8 consultas no dia
Resultado: Poucos hor√°rios livres
```

#### **Cen√°rio 3: M√©dico ausente**
```
Evento: "Dr. Jo√£o - AUSENTE" (dia todo)
Resultado: Nenhum hor√°rio dispon√≠vel
```

#### **Cen√°rio 4: Fim de semana**
```
Eventos: S√°bado/Domingo
Resultado: Sistema pula automaticamente
```

---

## üìû **Suporte e D√∫vidas**

### **Se algo n√£o funcionar:**

1. **Verifique os logs do Django:**
   ```bash
   python manage.py runserver
   # Observe mensagens de erro no console
   ```

2. **Teste conex√£o b√°sica:**
   ```bash
   python test_calendar.py
   ```

3. **Verifique arquivo de credenciais:**
   ```bash
   # Deve existir e ser v√°lido JSON
   python -c "import json; print(json.load(open('service-account-key.json'))['client_email'])"
   ```

4. **Confirme permiss√µes do calend√°rio:**
   - Email da conta de servi√ßo deve estar na lista de compartilhamento
   - Permiss√£o deve ser "Ver todos os detalhes"

---

## üéØ **Resultado Final**

Ap√≥s seguir todos os passos, voc√™ ter√°:

‚úÖ **Calend√°rio de teste** funcionando  
‚úÖ **Integra√ß√£o real** com Google Calendar API  
‚úÖ **Eventos filtrados** por m√©dico automaticamente  
‚úÖ **Chatbot consultando** hor√°rios reais  
‚úÖ **Sistema h√≠brido** - IA + controle humano  

### **Exemplo de conversa real:**
```
üë§: "Dr. Jo√£o tem hor√°rio amanh√£?"
ü§ñ: "Dr. Jo√£o Carvalho dispon√≠vel amanh√£:
     üåÖ Manh√£: 08:00, 08:30, 10:00, 10:30
     üåÜ Tarde: 15:00, 15:30, 17:00
     
     (Baseado na agenda real da cl√≠nica)
     Para agendar: (11) 99999-9999"
```

**Agora voc√™ tem um sistema real funcionando com seu Google Calendar pessoal para testes!** üìÖ‚ú®üéØ
